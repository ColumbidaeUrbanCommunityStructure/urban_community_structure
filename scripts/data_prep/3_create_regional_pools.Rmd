---
title: "Create regional pools using BirdLife"
output: html_notebook
bibliography: ../ref.bib 
---

```{r}
source('../env.R')
```

# Generate Worldwide Distributions for all Columbidae

## Read in the Birdlife Distribution 
Birdlife dataset @Birdlife2020.

A download of the birdlife distributions can be requested from here:
https://datazone.birdlife.org/species/requestdis

```{r}
BIRDLIFE_DISTRIBUTIONS = '/Users/james/Dropbox/PhD/BirdLife/Distribution/SppDataRequest_columbidae/SppDataRequest.shp'
birdlife = st_read(BIRDLIFE_DISTRIBUTIONS)
head(birdlife)
```

## Read in the Birdlife Taxonomy
Load the birdlife taxonomy to find Columbidae species.

The taxonomy can be downloaded here:
https://datazone.birdlife.org/species/taxonomy

```{r}
st_crs(birdlife)
```

```{r}
BIRDLIFE_TAXONOMY = '/Users/james/Dropbox/PhD/BirdLife/Taxonomy/Handbook of the Birds of the World and BirdLife International Digital Checklist of the Birds of the World_Version_8.xlsx'
birdlifeTaxonomyWb = read_excel(BIRDLIFE_TAXONOMY)
birdlifeTaxonomyWb
```

```{r}
names(birdlifeTaxonomyWb) <- birdlifeTaxonomyWb[2,]
birdlifeTaxonomy <- birdlifeTaxonomyWb[-2,]
birdlifeTaxonomy
```

```{r}
birdlifeColumbidae = birdlifeTaxonomy[!is.na(birdlifeTaxonomy$Order) & birdlifeTaxonomy$Order == 'COLUMBIFORMES', c('SISRecID', 'Scientific name', 'Common name', 'Synonyms')]
names(birdlifeColumbidae) = c('birdlife_id', 'species_name', 'common_name', 'synonyms')
birdlifeColumbidae
```

Check to see if we have any missing distributions
```{r}
birdlifeColumbidae[!(birdlifeColumbidae$species_name %in% birdlife$SCI_NAME),]
```

Most of those species are extinct. The species not extinct are:
* Nesoenas picturata	(?)
* Geotrygon lawrencii (previously considered conspecific of Zentrygon carrikeri) - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/22729899
* Gallicolumba beccarii	- not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/22691066
* Geophaps ferruginea - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/22725184 - lumped in with G. plumifera
* Ducula constans - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/ducula-constans
* Ducula salvadorii	 - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/45448199 - previously lumped as D. pinon
* Ptilinopus subgularis	 - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/22691351
* Ramphiculus meridionalis - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/22728045 - previously placed in the genus Ptilinopus and lumped as P. fischeri
* Stigmatopelia chinensis - not a species recognised by birdlife http://datazone.birdlife.org/species/factsheet/stigmatopelia-chinensis

Extinct species:
* Caloenas maculata	
* Nesoenas rostrata	
* Gallicolumba norfolciensis

### Missing Nesoenas picturata
```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Nesoenas picturata',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Nesoenas picturatus',]
```
```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22690364',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22690364'] = 'Columba picturata; Streptopelia picturata,Nesoenas picturata'
```


### Missing Geotrygon lawrencii
Previously considered conspecific of Zentrygon carrikeri

http://datazone.birdlife.org/species/factsheet/22729899

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Geotrygon lawrencii',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Zentrygon carrikeri',]
```
```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22690901',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22690901'] = 'Geotrygon carrikeri,Geotrygon lawrencii'
```

### Missing Gallicolumba beccarii
http://datazone.birdlife.org/species/factsheet/22691066

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Gallicolumba beccarii',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Pampusana beccarii',]
```
```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '60444792',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '60444792'] = 'Gallicolumba beccarii'
```


### Missing Geophaps ferruginea
http://datazone.birdlife.org/species/factsheet/22725184 - lumped in with G. plumifera

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Geophaps ferruginea',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Geophaps plumifera',]
```
```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22690682',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22690682'] = 'Geophaps ferruginea'
```

### Missing Ducula constans
http://datazone.birdlife.org/species/factsheet/ducula-constans

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Ducula constans',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Ducula spilorrhoa',]
```

```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22733554',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22733554'] = 'Ducula constans'
```

### Missing Ducula salvadorii
http://datazone.birdlife.org/species/factsheet/45448199 - previously lumped as D. pinon

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Ducula salvadorii',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Ducula pinon',]
```

```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22691760',]
```

Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22691760'] = 'Ducula salvadorii'
```

### Missing Ptilinopus subgularis
http://datazone.birdlife.org/species/factsheet/22691351

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Ptilinopus subgularis',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Ramphiculus subgularis',]
```

```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22728146',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22728146'] = 'Ptilinopus subgularis'
```

### Missing Ramphiculus meridionalis
http://datazone.birdlife.org/species/factsheet/22728045 - previously placed in the genus Ptilinopus and lumped as P. fischeri

```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Ramphiculus meridionalis',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Ramphiculus fischeri',]
```
```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '22691332',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '22691332'] = 'Ramphiculus meridionalis'
```

### Missing Stigmatopelia chinensis
```{r}
birdlifeColumbidae[birdlifeColumbidae$species_name == 'Stigmatopelia chinensis',]
```

```{r}
birdlife[birdlife$SCI_NAME == 'Spilopelia chinensis',]
```

```{r}
birdlifeColumbidae[birdlifeColumbidae$birdlife_id == '60482887',]
```
Already present, update synonyms
```{r}
birdlifeColumbidae$synonyms[birdlifeColumbidae$birdlife_id == '60482887'] = 'Streptopelia chinensis,Stigmatopelia chinensis'
```

## Store Birdlife taxonomy
```{r}
write_csv(birdlifeColumbidae[birdlifeColumbidae$species_name %in% birdlife$SCI_NAME,], filename(BIRDLIFE_WORKING_OUTPUT_DIR, 'taxonomy.csv'))
birdlifeColumbidae = read_csv(filename(BIRDLIFE_WORKING_OUTPUT_DIR, 'taxonomy.csv'))
head(birdlifeColumbidae)
```

## Filter Birdlife Distributions to only Columbidae
Do we have any distributions not in our taxonomy?
```{r}
birdlife[!(birdlife$SCI_NAME %in% birdlifeColumbidae$species_name),]
```

```{r}
COLUMBIDAE_WORLD_DISTRIBUTIONS = filename(BIRDLIFE_WORKING_OUTPUT_DIR, "columbidae_world.shp")
write_sf(birdlife, COLUMBIDAE_WORLD_DISTRIBUTIONS)
columbidaeDistribution = read_sf(COLUMBIDAE_WORLD_DISTRIBUTIONS)
```


Free up memory by removing birdlife data from workspace
```{r}
rm(birdlife)
rm(birdlifeTaxonomy)
rm(birdlifeTaxonomy_tmp)
rm(birdlifeTaxonomyWb)
rm(birdlifeTaxonomyWb_Sheets)
```

```{r}
st_crs(columbidaeDistribution)
```

# Create intersection of Columbidae Distributions with Urban Spaces
Read in our initial city vectors, we will join these to our checklists
```{r}
initial_city_selection = read_sf(filename(mkdir(GEO_WORKING_OUTPUT_DIR, 'cities'), 'initial_selection.shp'))
```

```{r}
st_crs(initial_city_selection)
```

```{r}
sf::sf_use_s2(FALSE)

urban_columbidae_distributions = st_join(initial_city_selection, columbidaeDistribution) 

urban_columbidae_distributions
```

## Check birdlife distribution data

Species with unknown presence?
```{r}
urban_columbidae_distributions[urban_columbidae_distributions$PRESENCE > 5, c('SCI_NAME', 'city_name', 'city_id')]
```


Any extinct species?
```{r}
urban_columbidae_distributions[urban_columbidae_distributions$PRESENCE == 5, c('SCI_NAME', 'city_name', 'city_id')]
```

Possibly Extinct species
```{r}
urban_columbidae_distributions[urban_columbidae_distributions$PRESENCE == 4, c('SCI_NAME', 'city_name', 'city_id')]
```

## Map seasonal and origin to string values
```{r}
urban_columbidae_distributions$seasonal_desc = "Unknown Code"
urban_columbidae_distributions$seasonal_desc[urban_columbidae_distributions$SEASONAL == "1"] = "Resident"
urban_columbidae_distributions$seasonal_desc[urban_columbidae_distributions$SEASONAL == "2"] = "Breeding Season" 
urban_columbidae_distributions$seasonal_desc[urban_columbidae_distributions$SEASONAL == "3"] = "Non-breeding Season" 
urban_columbidae_distributions$seasonal_desc[urban_columbidae_distributions$SEASONAL == "4"] = "Passage" 
urban_columbidae_distributions$seasonal_desc[urban_columbidae_distributions$SEASONAL == "5"] = "Seasonal occurence uncertain"
```

```{r}
urban_columbidae_distributions$origin_desc = "Unknown Code"
urban_columbidae_distributions$origin_desc[urban_columbidae_distributions$ORIGIN == "1"] = "Native"
urban_columbidae_distributions$origin_desc[urban_columbidae_distributions$ORIGIN == "2"] = "Reintroduced" 
urban_columbidae_distributions$origin_desc[urban_columbidae_distributions$ORIGIN == "3"] = "Introduced" 
urban_columbidae_distributions$origin_desc[urban_columbidae_distributions$ORIGIN == "4"] = "Vagrant" 
urban_columbidae_distributions$origin_desc[urban_columbidae_distributions$ORIGIN == "5"] = "Origin Uncertain"
urban_columbidae_distributions$origin_desc[urban_columbidae_distributions$ORIGIN == "6"] = "Assisted Colonisation"
```

```{r}
urban_columbidae_distributions$presence_desc = "Unknown Code"
urban_columbidae_distributions$presence_desc[urban_columbidae_distributions$PRESENCE == "1"] = "Extant"
urban_columbidae_distributions$presence_desc[urban_columbidae_distributions$PRESENCE == "2"] = "Probably Extant" 
urban_columbidae_distributions$presence_desc[urban_columbidae_distributions$PRESENCE == "3"] = "Possibly Extant" 
urban_columbidae_distributions$presence_desc[urban_columbidae_distributions$PRESENCE == "4"] = "Possibly Extinct" 
urban_columbidae_distributions$presence_desc[urban_columbidae_distributions$PRESENCE == "5"] = "Extinct"
urban_columbidae_distributions$presence_desc[urban_columbidae_distributions$PRESENCE == "6"] = "Presence Uncertain"
```

```{r}
cache_urban_columbidae_distributions = filename(BIRDLIFE_WORKING_OUTPUT_DIR, 'urban_distributions_birdlife_only.csv')
write_csv(urban_columbidae_distributions, cache_urban_columbidae_distributions)
urban_columbidae_distributions = read_csv(cache_urban_columbidae_distributions)
```

## Missing North American distribution of Streptopelia decaocto and Columba Livia
Birdlife is missing the recent invasion of Streptopelia decaocto into North America. 
We supplement the data for Streptopelia decaocto with the range from eBird's Status and Trends dataset.

This data can be downloaded here:
https://science.ebird.org/en/status-and-trends/species/eucdov/downloads

The country boundandaries can be downloaded from the world bank here:
https://datacatalog.worldbank.org/search/dataset/0038272/World-Bank-Official-Boundaries

```{r}
COUNTRY_BOUNDARIES = '/Users/james/Dropbox/PhD/WorldBank_countries_Admin0_10m/WB_countries_Admin0_10m.shp'
world_map = st_simplify(st_read(COUNTRY_BOUNDARIES), dTolerance = 0.02)
```
### Collared Dove
Existing range from Birdlife
```{r}
sf::sf_use_s2(FALSE)
coldov_vect = st_simplify(columbidaeDistribution[columbidaeDistribution$SCI_NAME == 'Streptopelia decaocto', c('PRESENCE')], dTolerance = 0.02)

ggplot() +  
  geom_sf(data = world_map, aes(geometry = geometry)) +
  geom_sf(data = coldov_vect, aes(geometry = geometry), fill = "red")
```

Range from eBird
```{r}
EBIRD_EUCDOV_RANGE = '/Users/james/Dropbox/PhD/eBird/eucdov_range_2022/eucdov_range_2022.gpkg'
eucdov_range_vect = st_read(EBIRD_EUCDOV_RANGE)

ggplot() +  
  geom_sf(data = world_map, aes(geometry = geometry)) +
  geom_sf(data = eucdov_range_vect["scientific_name"], aes(geometry = geom), fill = "red")
```

Extract cities from eBird range
```{r}
sf::sf_use_s2(FALSE)

existing_eucdov_cities = urban_columbidae_distributions$city_id[urban_columbidae_distributions$SCI_NAME == 'Streptopelia decaocto']

eucdov_distribution = st_join(initial_city_selection, eucdov_range_vect) 

eucdov_distribution[!is.na(eucdov_distribution$species_code) & !(eucdov_distribution$city_id %in% existing_eucdov_cities),]
```


```{r}
missing_eucdov_cities = data.frame(
    species_name = 'Streptopelia decaocto', 
    city_id = eucdov_distribution$city_id[!is.na(eucdov_distribution$species_code) & !(eucdov_distribution$city_id %in% existing_eucdov_cities)],
    city_name= eucdov_distribution$city_name[!is.na(eucdov_distribution$species_code) & !(eucdov_distribution$city_id %in% existing_eucdov_cities)],
    origin = 'Introduced',
    seasonal = 'Resident',
    presence = 'Extant'
)
missing_eucdov_cities
```

### Rock dove
Existing range from Birdlife
```{r}
sf::sf_use_s2(FALSE)
rocdov_vect = st_simplify(columbidaeDistribution[columbidaeDistribution$SCI_NAME == 'Columba livia', c('PRESENCE')], dTolerance = 0.02)

ggplot() +  
  geom_sf(data = world_map, aes(geometry = geometry)) +
  geom_sf(data = rocdov_vect, aes(geometry = geometry), fill = "red")
```

Range from eBird
```{r}
EBIRD_ROCPIG_RANGE = '/Users/james/Dropbox/PhD/eBird/rocpig_range_2022/rocpig_range_2022.gpkg'
rocpig_range_vect = st_read(EBIRD_ROCPIG_RANGE)
ggplot() +  
  geom_sf(data = world_map, aes(geometry = geometry)) +
  geom_sf(data = rocpig_range_vect["scientific_name"], aes(geometry = geom), fill = "red")
```

```{r}
sf::sf_use_s2(FALSE)

existing_rocpig_cities = urban_columbidae_distributions$city_id[urban_columbidae_distributions$SCI_NAME == 'Columba livia']

rocpig_distribution = st_join(initial_city_selection, rocpig_range_vect) 

rocpig_distribution[!is.na(rocpig_distribution$species_code) & !(rocpig_distribution$city_id %in% existing_rocpig_cities),]
```

```{r}
missing_rocpig_cities = data.frame(
    species_name = 'Columba livia', 
    city_id = rocpig_distribution$city_id[!is.na(rocpig_distribution$species_code) & !(rocpig_distribution$city_id %in% existing_rocpig_cities)],
    city_name= rocpig_distribution$city_name[!is.na(rocpig_distribution$species_code) & !(rocpig_distribution$city_id %in% existing_rocpig_cities)],
    origin = 'Introduced',
    seasonal = 'Resident',
    presence = 'Extant'
)
missing_rocpig_cities
```

## Add Spotted dove's expanded range into China
Existing range from Birdlife
```{r}
sf::sf_use_s2(FALSE)
spodov_vect = st_simplify(columbidaeDistribution[columbidaeDistribution$SCI_NAME %in% c('Spilopelia chinensis','Spilopelia suratensis','Patagioenas albipennis'), c('SCI_NAME')], dTolerance = 0.02)

ggplot() +  
  geom_sf(data = world_map, aes(geometry = geometry)) +
  geom_sf(data = spodov_vect, aes(geometry = geometry, fill = SCI_NAME))
```

Range from eBird
```{r}
EBIRD_SPODOV_RANGE = '/Users/james/Dropbox/PhD/eBird/spodov_range_2022/spodov_range_2022.gpkg'
spodov_range_vect = st_read(EBIRD_SPODOV_RANGE)
ggplot() +  
  geom_sf(data = world_map, aes(geometry = geometry)) +
  geom_sf(data = spodov_range_vect["scientific_name"], aes(geometry = geom), fill = "red")
```

```{r}
sf::sf_use_s2(FALSE)

existing_spodov_cities = urban_columbidae_distributions$city_id[urban_columbidae_distributions$SCI_NAME %in% c('Spilopelia chinensis','Spilopelia suratensis','Patagioenas albipennis')]

spodov_distribution = st_join(initial_city_selection, spodov_range_vect) 

spodov_distribution[!is.na(spodov_distribution$species_code) & !(spodov_distribution$city_id %in% existing_spodov_cities),]
```

```{r}
missing_spodov_cities = data.frame(
    species_name = 'Spilopelia chinensis', 
    city_id = spodov_distribution$city_id[!is.na(spodov_distribution$species_code) & !(spodov_distribution$city_id %in% existing_spodov_cities)],
    city_name= spodov_distribution$city_name[!is.na(spodov_distribution$species_code) & !(spodov_distribution$city_id %in% existing_spodov_cities)],
    origin = 'Introduced',
    seasonal = 'Resident',
    presence = 'Extant'
)
missing_spodov_cities
```

## Store regional pool result
```{r}
urban_distribution = rbind(
  data.frame(
    species_name = urban_columbidae_distributions$SCI_NAME, 
    city_id = urban_columbidae_distributions$city_id,
    city_name= urban_columbidae_distributions$city_name,
    origin = urban_columbidae_distributions$origin_desc,
    seasonal = urban_columbidae_distributions$seasonal_desc,
    presence = urban_columbidae_distributions$presence_desc
  ),
 rbind(missing_eucdov_cities, rbind(missing_rocpig_cities, missing_spodov_cities))
)
```

```{r}
BIRDLIFE_URBAN_DISTRIBUTION = filename(BIRDLIFE_WORKING_OUTPUT_DIR, 'urban_distributions.csv')
write_csv(urban_distribution, BIRDLIFE_URBAN_DISTRIBUTION)
```

## Examine result
```{r}
urban_distribution = read_csv(BIRDLIFE_URBAN_DISTRIBUTION)
```

Species in Manchester's regional pool
```{r}
urban_distribution %>% filter(city_name == 'Manchester') 
```

Species in Miami's regional pool
```{r}
urban_distribution %>% filter(city_name == 'Miami') 
```

Cities with Common Woodpigeon in regional pool
```{r}
urban_distribution %>% filter(species_name == 'Columba palumbus')
```

Cities with Collared Dove in regional pool
```{r}
urban_distribution %>% filter(species_name == 'Streptopelia decaocto')
```

Regional pool sizes
```{r}
urban_distribution %>% group_by(city_id, city_name) %>% summarise(pool_size = n()) %>% arrange(pool_size)
```


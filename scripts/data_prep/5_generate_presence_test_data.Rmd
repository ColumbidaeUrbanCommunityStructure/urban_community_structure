---
title: "Generate presence test data using eBird Status & Trends"
output: html_notebook
bibliography: ../ref.bib 
---

```{r}
source('../env.R')
```

# Select species
These are all the species currently available from the eBird Status and Trends data product @eBird2023.
https://science.ebird.org/en/status-and-trends/species#columb2


```{r}
species_available = c("Streptopelia decaocto",
"Streptopelia semitorquata",
"Streptopelia capicola",
"Streptopelia tranquebarica",
"Spilopelia chinensis",
"Macropygia phasianella",
"Chalcophaps indica",
"Ocyphaps lophotes",
"Geopelia humeralis",
"Columbina inca",
"Columbina passerina",
"Columbina minuta",
"Columbina talpacoti",
"Columbina buckleyi",
"Columbina squammata",
"Columbina picui",
"Claravis pretiosa",
"Geotrygon montana",
"Leptotila verreauxi",
"Leptotila jamaicensis",
"Leptotila cassinii",
"Leptotila plumbeiceps",
"Zentrygon costaricensis",
"Zentrygon lawrencii",
"Zentrygon albifacies",
"Zentrygon chiriquensis",
"Zenaida meloda",
"Zenaida asiatica",
"Zenaida aurita",
"Zenaida auriculata",
"Zenaida macroura",
"Treron affinis",
"Treron phoenicopterus",
"Treron sieboldii",
"Treron formosae",
"Ducula aenea",
"Hemiphaga novaeseelandiae",
"Columba livia",
"Columba guinea",
"Columba oenas",
"Columba palumbus",
"Patagioenas cayennensis",
"Patagioenas speciosa",
"Patagioenas squamosa",
"Patagioenas picazuro",
"Patagioenas corensis",
"Patagioenas maculosa",
"Patagioenas leucocephala",
"Patagioenas flavirostris",
"Patagioenas fasciata",
"Patagioenas araucana",
"Patagioenas subvinacea",
"Patagioenas nigrirostris",
"Streptopelia turtur",
"Streptopelia orientalis")

length(species_available)
```

Filter against library list, as not everything on website is availble in library
```{r}
species_available = ebirdst_runs$scientific_name[ebirdst_runs$scientific_name %in% species_available]
species_available
```

## First check taxonomic mapping required for any of these species:
```{r}
taxonmomic_mapping = read_csv(filename(TAXONOMY_OUTPUT_DIR, 'taxonomy_mapping.csv'))
```

Species with 1 eBird taxa, and multiple Birdlife taxa will reuqire the ranges of the Birdlife taxa to be combined. 
```{r}
taxonmomic_mapping[taxonmomic_mapping$ebird_species_name %in% species_available,] %>%
  group_by(ebird_species_name) %>% 
  summarise(number_of_birdlife_species = n(), birdlife_species_names = paste(species_name, collapse = ",")) %>%
  filter(number_of_birdlife_species > 1)
```

* *Patagioenas fasciata*, will need the range of Patagioenas fasciata and Patagioenas albilinea combined.

* *Spilopelia chinensis*, will need the range of Spilopelia chinensis, Spilopelia suratensis, and Patagioenas albipennis combined.

Check whether we need to map eBird species names to Birdlife
```{r}
taxonmomic_mapping[taxonmomic_mapping$ebird_species_name %in% species_available,] %>%
  filter(ebird_species_name != species_name) 
```

Species with 1 Birdlife taxa, and multiple eBird taxa will, would mean that we would have cities with no records but potentially have presence test data. We should avoid these species.
```{r}
taxonmomic_mapping[taxonmomic_mapping$ebird_species_name %in% species_available,] %>%
  group_by(species_name) %>% 
  summarise(number_of_ebird_species = n(), ebird_species_names = paste(ebird_species_name, collapse = ",")) %>%
  filter(number_of_ebird_species > 1)
```

```{r}
test_species = species_available
```

# Create regional pool data
```{r}
inspection_cities = c('Manchester', 'Bogota', 'Los Angeles', 'Jakarta', 'Nairobi')
```

```{r}
regional_pool_data_input = read_csv(filename(BIRDLIFE_WORKING_OUTPUT_DIR, 'urban_distributions.csv'))
regional_pool_data_input$seasonal = factor(regional_pool_data_input$seasonal, levels = c('Resident', 'Breeding Season', 'Non-breeding Season', 'Passage', ordered = T))
regional_pool_data_input[regional_pool_data_input$city_name %in% inspection_cities,] 
```

```{r}
regional_pool_data = regional_pool_data_input %>% 
  filter(species_name %in% species_available) %>%
  arrange(seasonal) %>%
  group_by(city_id, city_name, species_name) %>%
  summarise(seasonal = first(seasonal)) %>%
  arrange(city_id, species_name)
```

```{r}
regional_pool_data[regional_pool_data$city_name %in% inspection_cities,]
```

# Download Status and Trends data
```{r}
key = read_file(filename(KEYS_DIR, 'ebirdst.txt'))
set_ebirdst_access_key(key, overwrite = T)
ebirdst_data_dir()
```

```{r}
for (species in test_species) {
  print(paste('fetching', species))
  ebirdst_download_status(
    species = species,
    download_abundance = TRUE,
    download_occurrence = FALSE,
    download_count = FALSE,
    download_ranges = FALSE,
    download_regional = FALSE,
    download_pis = FALSE,
    download_ppms = FALSE,
    download_all = FALSE
  )
}
```

## Create abundance data
Read in our initial city vectors, we will join these to our checklists
```{r}
initial_city_selection = vect(filename(mkdir(GEO_WORKING_OUTPUT_DIR, 'cities'), 'initial_selection.shp'))
```

```{r}
city_data = data.frame(initial_city_selection)
city_data$ID = as.double(rownames(city_data))
city_data
```

```{r}
abundance_data = data.frame()

for (species in test_species) {
  abd <- load_raster(species, resolution = "3km", product = "abundance", period = "seasonal")
  abd_wgs84 = project(abd, initial_city_selection)
  city_abundance = terra::extract(abd_wgs84, initial_city_selection)
  
  if ("resident" %in% colnames(city_abundance)) {
     result = city_abundance %>% group_by(ID) %>% summarise(
       breeding = NA, 
       nonbreeding = NA, 
       resident = mean(resident), 
       species = species
     )
     abundance_data = rbind(abundance_data, inner_join(result, city_data[,c('ID', 'city_id', 'city_name')]))
  } else {
    result = city_abundance %>% group_by(ID) %>% summarise(
      breeding = mean(breeding), 
      nonbreeding = mean(nonbreeding), 
      resident = NA, 
      species = species
    ) 
    abundance_data = rbind(abundance_data, inner_join(result, city_data[,c('ID', 'city_id', 'city_name')]))
  }
}
```


```{r}
write_csv(abundance_data, filename(EBIRD_WORKING_OUTPUT_DIR, 'ebird_trends_abundance_test_data.csv'))
abundance_data = read_csv(filename(EBIRD_WORKING_OUTPUT_DIR, 'ebird_trends_abundance_test_data.csv'))
```

Filter to regional pools
```{r}
abundance_data_regional = left_join(regional_pool_data, abundance_data, by = c('city_id' = 'city_id', 'city_name' = 'city_name', 'species_name' = 'species'))
abundance_data_regional = abundance_data_regional %>% arrange(city_id) %>% select(city_id, city_name, species_name, seasonal, breeding, nonbreeding, resident)
```

```{r}
abundance_data_regional[abundance_data_regional$city_name %in% inspection_cities,]
```

Are any species now missing that are abundant?
```{r}
city_id_species_pairs_present = paste(abundance_data_regional$species_name, abundance_data_regional$city_id, sep = '::')
abundance_data %>% 
  filter(breeding > 0 | nonbreeding > 0 | resident > 0) %>% 
  group_by(city_id, species) %>% 
  filter(!(paste(species, city_id, sep = '::') %in% city_id_species_pairs_present)) %>%
  select(city_id, city_name, species, breeding, nonbreeding, resident)
```

# Create urban summary data
Get number of checklists and total effort in each city
```{r}
urban_checklists = read_csv(filename(EBIRD_WORKING_OUTPUT_DIR, 'urban_checklists.csv'))

urban_summary = urban_checklists %>% group_by(city_id, city_name) %>% summarise(total_city_checklists = n(), total_city_effort = sum(duration))

urban_summary[urban_summary$city_name %in% inspection_cities,]
```

# Create urban pools
For each of our test species, find the number of checklists and total effort in each city
```{r}
ebird_raw = read_csv(filename(EBIRD_WORKING_OUTPUT_DIR, 'urban_columbidae.csv'))
head(ebird_raw)
```

Join eBird data to taxonomy, and then ensure species only appear on each checklists. e.g. deduplicate any species that had duplicates created by taxonomy mapping.
```{r}
urban_columbidae_raw_ebird_records = 
  left_join(ebird_raw, taxonmomic_mapping, by = c('species_name' = 'ebird_species_name')) %>%
  filter(species_name.y %in% species_available) %>%
  group_by(checklist_id, city_id, city_name, species_name.y) %>%
  summarise(
    duration = max(duration)
  ) %>%
  rename(species_name = species_name.y) %>%
  arrange(city_name)

urban_columbidae_raw_ebird_records[urban_columbidae_raw_ebird_records$city_name %in% inspection_cities, ]
```
Now calculate the total number of checklists each species appears on, and then total effort of those checklists.
This gives a single row for each species in each city.
Then join the data onto the regional pool data, and the urban summary data.
```{r}
urban_ebird_columbidae_city_summary = urban_columbidae_records_with_checklist_data %>% 
  group_by(city_id, city_name, species_name) %>% 
  summarise(total_presence_checklists = n(), total_presence_effort = sum(duration)) %>%
  left_join(regional_pool_data, by = c('city_id' = 'city_id', 'city_name' = 'city_name', 'species_name' = 'species_name')) %>%
  left_join(urban_summary, by = c('city_id' = 'city_id', 'city_name' = 'city_name')) %>%
  arrange(city_id, species_name)
```

NA for seasonal indicates that the species is on an eBird checklist for the city, but not in the birdlife regional pool.
```{r}
urban_ebird_columbidae_city_summary[urban_ebird_columbidae_city_summary$city_name %in% inspection_cities,]
```

We also want records for each city that could have that pigeon (e.g. in regional pool range) but has no eBird records.
Create absence records for all species in the birdlife regional pool data for all cities.
```{r}
urban_columbidae_absence_records_part1 = left_join(regional_pool_data, urban_summary)

urban_columbidae_absence_records_part1$total_presence_checklists = 0
urban_columbidae_absence_records_part1$total_presence_effort = 0

urban_columbidae_absence_records = urban_columbidae_absence_records_part1[!is.na(urban_columbidae_absence_records_part1$total_city_checklists),]

urban_columbidae_absence_records[urban_columbidae_absence_records$city_name %in% inspection_cities,]
```

Append the absence and presence data together, and then deduplicate to ensure only one species per city.
Then calculate the percentage of all checklists, and the percentage of total effort in a city for each species.
```{r}
urban_columbidae_presence_and_absence = rbind(urban_ebird_columbidae_city_summary, urban_columbidae_absence_records) %>%
  group_by(city_id, city_name, species_name, total_city_checklists, total_city_effort, seasonal) %>%
  summarise(total_presence_checklists = max(total_presence_checklists), total_presence_effort = max(total_presence_effort)) %>%
  arrange(city_id, species_name)

urban_columbidae_presence_and_absence$percentage_checklists = urban_columbidae_presence_and_absence$total_presence_checklists * 100 / urban_columbidae_presence_and_absence$total_city_checklists
urban_columbidae_presence_and_absence$percentage_effort = urban_columbidae_presence_and_absence$total_presence_effort * 100 / urban_columbidae_presence_and_absence$total_city_effort

urban_columbidae_presence_and_absence[urban_columbidae_presence_and_absence$city_name %in% inspection_cities,]
```

# Join all data together
Finally join our our test data result to show predicted abundance, remove any NA abundance as there is insufficent data in these places for a prediction.
```{r}
columbidae = left_join(urban_columbidae_presence_and_absence, abundance_data, by = c('species_name' = 'species', 'city_id' = 'city_id', 'city_name' = 'city_name'))
columbidae[columbidae$city_name %in% inspection_cities,]
```

# Plot to see Expected test abundance vs checklists
```{r}
ggplot(columbidae[columbidae$species_name == 'Columba palumbus',], aes(y = percentage_checklists, x = breeding, color = log(total_city_checklists))) + geom_jitter() + geom_jitter() + scale_colour_gradient2(
  low = "red",
  mid = "yellow",
  high = "darkgreen",
  midpoint = log(100),
  space = "Lab",
  na.value = "grey50",
  guide = "colourbar",
  aesthetics = "colour",
)
```


```{r}
plot_city_species = function(city_id) {
  city_name = urban_summary$city_name[urban_summary$city_id == city_id]
  total_checklists = urban_summary$total_city_checklists[urban_checklists$city_id == city_id]
  
  ggplot(columbidae[columbidae$city_id == city_id,], aes(x = species_name, y = percentage_checklists, fill = seasonal)) + 
    geom_bar(stat = "identity") + 
    geom_text(aes(label = paste('breeding', round(breeding, 1), '\nresident', round(resident, 1)))) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    xlab('Species name') + ylab('% of Checklist present') + 
    facet_wrap(~city_id) + 
    geom_hline(yintercept=5, linetype='dotted', col = 'red') +
    labs(title = paste(city_name, total_checklists))
}
```

```{r}
plot_city_species(14)
```

```{r}
plot_city_species(624)
```

```{r}
plot_city_species(1786)
```

```{r}
plot_city_species(4830)
```

```{r}
plot_city_species(11920)
```

# Select sample size: Min number of checklists
n = ((Z * Z) * p * (1−p)) / (E * E)

(e.g., 99% corresponds to Z≈2.576Z≈2.576).
 
So for present = more than 5% of checklists.

p is the estimated probability of success (the proportion of checklists where the species is present).
E is the margin of error (half the width of the confidence interval).

```{r}
(2.576^2 * 0.95 * 0.05) / 0.01^2
```

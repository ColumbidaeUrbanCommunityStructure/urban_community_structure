---
title: "Similarity of introduced birds"
output: html_notebook
---

```{r}
source('../env.R')
```

# Load required data
```{r}
trait_data = read.csv(filename(TAXONOMY_OUTPUT_DIR, 'traits_ebird.csv')) %>% dplyr::select(ebird_species_name, beak_width, hwi, mass)
trait_data
```

```{r}
community_data = read.csv(filename(COMMUNITY_OUTPUT_DIR, 'communities_for_analysis.csv')) %>% 
  dplyr::select(city_id, city_name, ebird_species_name, origin, relative_abundance_proxy) %>% 
  left_join(trait_data, by = 'ebird_species_name')
community_data
```




```{r}
columbidae_tree = read.tree(filename(TAXONOMY_OUTPUT_DIR, 'phylogeny.tre'))
plot(columbidae_tree)
```

# Find communities with introduced species
```{r}
urban_introduced_species = community_data %>% filter(origin == 'Introduced') %>% filter(relative_abundance_proxy > 0)
urban_introduced_species
```

```{r}
urban_native_species = community_data %>% filter(origin != 'Introduced') %>% filter(relative_abundance_proxy > 0)
urban_native_species
```

```{r}
regional_native_species = community_data %>% filter(origin != 'Introduced') %>% filter(relative_abundance_proxy == 0)
regional_native_species
```

# Find cities we can use to compare introduced species vs regional species
```{r}
city_names = function(df) {
  df %>% dplyr::select(city_id, city_name) %>% distinct()
}

cities_available_for_test = purrr::reduce(
  list(
    city_names(urban_introduced_species),
    city_names(urban_native_species),
    city_names(regional_native_species)
  ),
  dplyr::intersect
)
cities_available_for_test
```

# Look at creating required metrics for a single city
```{r}
test_city = cities_available_for_test$city_name[1]
```

## Distance to nearest species across functional traits
```{r}
native_traits = urban_native_species %>%
  filter(city_name == test_city)

introduced_traits = urban_introduced_species %>%
  filter(city_name == test_city)

regional_traits = regional_native_species %>%
  filter(city_name == test_city)

introduced_traits %>%
  rowwise() %>%
  mutate(
    min_dist_beak_width = min(abs(beak_width - native_traits$beak_width)),
    min_dist_mass       = min(abs(mass - native_traits$mass)),
    min_dist_hwi        = min(abs(hwi - native_traits$hwi))
  ) %>%
  ungroup()

regional_traits %>%
  rowwise() %>%
  mutate(
    min_dist_beak_width = min(abs(beak_width - native_traits$beak_width)),
    min_dist_mass       = min(abs(mass - native_traits$mass)),
    min_dist_hwi        = min(abs(hwi - native_traits$hwi))
  ) %>%
  ungroup()
```

## Distance to nearest species in phylogeny
```{r}
communities_matrix =  function(urban_community, comparison_community) {
  urban = str_replace(urban_community$ebird_species_name, ' ', '_')
  compare = str_replace(comparison_community$ebird_species_name, ' ', '_')
  
  spp = c(urban, compare)

  comm = matrix(
    0,
    nrow = 1 + length(compare),
    ncol = length(spp),
    dimnames = list(c("urban", compare), spp)
  )

  comm["urban", urban] = 1
  comm[compare, compare] = 1
  comm
}

communities_matrix(native_traits, introduced_traits)
communities_matrix(native_traits, regional_traits)
```

```{r}
D = cophenetic(columbidae_tree)

min_phylo_distance = function(native_traits, compare_to_traits) {
  cdnt = picante::comdistnt(communities_matrix(native_traits, compare_to_traits), D)
  cdnt_m = as.matrix(cdnt)
  
  
  tibble(species = str_replace(compare_to_traits$ebird_species_name, ' ', '_')) %>%
      mutate(
        ebird_species_name = str_replace(species, '_', ' '),
        min_phylo_dist = cdnt_m[species, "urban"]
      ) %>% 
    dplyr::select(-species)
}

min_phylo_distance(native_traits, introduced_traits)
min_phylo_distance(native_traits, regional_traits)
```

# Create all metrics
```{r}
min_trait_distances = function(given_city_id) {
  native = urban_native_species %>%
    filter(city_id == given_city_id)
  
  introduced = urban_introduced_species %>%
    filter(city_id == given_city_id)
  
  regional = regional_native_species %>%
    filter(city_id == given_city_id)
  
  rbind(
    introduced %>%
      rowwise() %>%
      mutate(
        min_dist_beak_width = min(abs(beak_width - native$beak_width)),
        min_dist_mass       = min(abs(mass - native$mass)),
        min_dist_hwi        = min(abs(hwi - native$hwi))
      ) %>%
      ungroup() %>%
      left_join(min_phylo_distance(native, introduced)) %>%
      mutate(type = 'Introduced')
    ,
    regional %>%
      rowwise() %>%
      mutate(
        min_dist_beak_width = min(abs(beak_width - native$beak_width)),
        min_dist_mass       = min(abs(mass - native$mass)),
        min_dist_hwi        = min(abs(hwi - native$hwi))
      ) %>%
      ungroup() %>%
      left_join(min_phylo_distance(native, regional)) %>%
      mutate(type = 'Available')
  ) %>%
  dplyr::select(city_id, city_name, ebird_species_name, type, min_dist_beak_width, min_dist_mass, min_dist_hwi, min_phylo_dist)
}

min_trait_distances(cities_available_for_test$city_id[1])
```

```{r}
result_df = data.frame()

for (i in 1:nrow(cities_available_for_test)) {
  test_city_id = cities_available_for_test$city_id[i]
  result_df = rbind(result_df, min_trait_distances(test_city_id))
}

result_df = result_df %>% mutate(type = as.factor(type), city_id = factor(city_id))
result_df
```

```{r}
str(result_df)
```

# Analysis results
## Plots
```{r}
ggplot(result_df, aes(x = type, y = min_dist_beak_width)) + geom_boxplot()
```

```{r}
ggplot(result_df, aes(x = type, y = min_dist_hwi)) + geom_boxplot()
```

```{r}
ggplot(result_df, aes(x = type, y = min_dist_mass)) + geom_boxplot()
```

```{r}
ggplot(result_df, aes(x = type, y = min_phylo_dist)) + geom_boxplot()
```

## Models


```{r}
levels(factor(result_df$type))
```

```{r}
check_distances_near_zero = result_df %>%
  group_by(type) %>%
  summarise(
    n = n(),
    bw_zeros = sum(min_dist_beak_width == 0),
    bw_p_zero = mean(min_dist_beak_width == 0),
    bw_median = median(min_dist_beak_width),
    hwi_zeros = sum(min_dist_hwi == 0),
    hwi_p_zero = mean(min_dist_hwi == 0),
    hwi_median = median(min_dist_hwi),
    mass_zeros = sum(min_dist_mass == 0),
    mass_p_zero = mean(min_dist_mass == 0),
    mass_median = median(min_dist_mass),
    phylo_zeros = sum(min_phylo_dist == 0),
    phylo_p_zero = mean(min_phylo_dist == 0),
    phylo_median = median(min_phylo_dist)
  )
check_distances_near_zero
```

### City random factor
Using Tweedie GLMM (good default when zeros exist)

```{r}
library(glmmTMB)
library(DHARMa)
```

#### Beak width
```{r}
mt_beak_width = glmmTMB(
  min_dist_beak_width ~ type + (1 | city_id),
  family = tweedie(link = "log"),
  data = result_df
)

summary(mt_beak_width)

# Diagnostics
res_beak_width = simulateResiduals(mt_beak_width)
plot(res_beak_width, form = factor(result_df$type))

# Test the group effect (Wald)
car::Anova(mt_beak_width, type = 2)
```
```{r}
mt_dis_beak_width = glmmTMB(
  min_dist_beak_width ~ type + (1 | city_id),
  family = tweedie(link = "log"),
  dispformula = ~ type,
  data = result_df
)

summary(mt_dis_beak_width)

# Diagnostics
res_dis_beak_width = simulateResiduals(mt_dis_beak_width)
plot(res_dis_beak_width, form = factor(result_df$type))

# Test the group effect (Wald)
car::Anova(mt_dis_beak_width, type = 2)
```

Is random effect needed?
```{r}
mt0_dis_beak_width =glmmTMB(
  min_dist_beak_width ~ type,
  family = tweedie(link = "log"),
  dispformula = ~ type,
  data = result_df
)
anova(mt0_dis_beak_width, mt_dis_beak_width)
```

```{r}
testDispersion(res_dis_beak_width)
testZeroInflation(res_dis_beak_width)
testOutliers(res_dis_beak_width)
```
```{r}
idx = which(res_dis_beak_width$scaledResiduals < 0.01 | res_dis_beak_width$scaledResiduals > 0.99)
result_df[idx, c("min_dist_beak_width", "type", "city_id", "city_name")]
```

Effect sizes
```{r}
library(emmeans)
emmeans(mt_dis_beak_width, ~ type, type = "response")     # back on original scale
contrast(emmeans(mt_dis_beak_width, ~ type, type = "response"), "pairwise")
```
These are the expected values of min_dist_beak_width for each type, averaged over the random effects, and then back-transformed to the response scale:
* Available: 0.493 (SE 0.0405), 95% CI 0.420 to 0.579
* Introduced: 0.354 (SE 0.0280), 95% CI 0.303 to 0.413

Interpretation: the model estimates that Available is ~1.39× (≈ 40%) higher than Introduced, on average, after accounting for city-level clustering.


#### HWI
```{r}
mt_hwi = glmmTMB(
  min_dist_hwi ~ type + (1 | city_id),
  family = tweedie(link = "log"),
  dispformula = ~ type,
  data = result_df
)

summary(mt_hwi)

# Diagnostics
res_hwi = simulateResiduals(mt_hwi)
plot(res_hwi, form = factor(result_df$type))

# Test the group effect (Wald)
car::Anova(mt_hwi, type = 2)
```

```{r}
testDispersion(res_hwi)
testZeroInflation(res_hwi)
testOutliers(res_hwi)
```

Effect sizes
```{r}
library(emmeans)
emmeans(mt_hwi, ~ type, type = "response")     # back on original scale
contrast(emmeans(mt_hwi, ~ type, type = "response"), "pairwise")
```
model estimates:
* Available: 1.45 (95% CI 1.30 – 1.62)
* Introduced: 5.31 (95% CI 4.66 – 6.04)

Interpretation: Available is only 0.274× Introduced — i.e. ~72% lower.

```{r}
mt_mass = glmmTMB(
  min_dist_mass ~ type + (1 | city_id),
  family = tweedie(link = "log"),
  dispformula = ~ type,
  data = result_df
)

summary(mt_mass)

# Diagnostics
res_mass = simulateResiduals(mt_mass)
plot(res_mass, form = factor(result_df$type))

# Test the group effect (Wald)
car::Anova(mt_mass, type = 2)
```

```{r}
testDispersion(res_mass)
testZeroInflation(res_mass)
testOutliers(res_mass)
```

Effect sizes
```{r}
library(emmeans)
emmeans(mt_mass, ~ type, type = "response")     # back on original scale
contrast(emmeans(mt_mass, ~ type, type = "response"), "pairwise")
```
model estimates:
* Available: 39.7 (SE 3.08), 95% CI 34.2 – 46.2
* Introduced: 69.9 (SE 6.36), 95% CI 58.1 – 84.2

Interpretation: Available is 0.558× Introduced — i.e. about 43% lower.

```{r}
min(result_df$min_phylo_dist)

mt_phylo_dist = glmmTMB(
  min_phylo_dist ~ type + (1 | city_id),
  family = Gamma(link = "log"),
  data = result_df
)

summary(mt_phylo_dist)

# Diagnostics
res_phylo_dist = simulateResiduals(mt_phylo_dist)
plot(res_phylo_dist, form = factor(result_df$type))

# Test the group effect (Wald)
car::Anova(mt_phylo_dist, type = 2)
```


```{r}
library(emmeans)
emmeans(mt_phylo_dist, ~ type, type = "response")     # back on original scale
contrast(emmeans(mt_phylo_dist, ~ type, type = "response"), "pairwise")
```

Model-based expected values:
* Available: 35.6 (SE 1.35), 95% CI 33.0 – 38.3
* Introduced: 47.8 (SE 1.93), 95% CI 44.2 – 51.8

Interpretation: Available is 0.744× Introduced, i.e. about 25.6% lower.


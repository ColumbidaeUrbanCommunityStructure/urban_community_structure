---
title: "Metrics for assessing community assembly processes"
output: html_notebook
bibliography: ../ref.bib  
---

```{r}
source('../env.R')
```

```{r}
community_data = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'community_assembly_metrics_using_relative_abundance.csv'))
head(community_data)
colnames(community_data)
```

```{r}
min(community_data$mntd_standard)
max(community_data$mntd_standard)
min(community_data$beak_width_fdiv_standard)
max(community_data$beak_width_fdiv_standard)
min(community_data$hwi_fdiv_standard)
max(community_data$hwi_fdiv_standard)
min(community_data$mass_fdiv_standard)
max(community_data$mass_fdiv_standard)
```

```{r}
min(community_data$mntd_normal)
max(community_data$mntd_normal)
min(community_data$beak_width_fdiv_normal)
max(community_data$beak_width_fdiv_normal)
min(community_data$hwi_fdiv_normal)
max(community_data$hwi_fdiv_normal)
min(community_data$mass_fdiv_normal)
max(community_data$mass_fdiv_normal)
```

Join on realms
```{r}
city_to_realm = read_csv(filename(CITY_DATA_OUTPUT_DIR, 'realms.csv'))
community_data_with_realm = left_join(community_data, city_to_realm)
```

Cities as points
```{r}
city_points = st_centroid(read_sf(filename(CITY_DATA_OUTPUT_DIR, 'city_selection.shp'))) %>% left_join(community_data_with_realm)
city_points_coords = st_coordinates(city_points)
city_points$latitude = city_points_coords[,1]
city_points$longitude = city_points_coords[,2]
```
  
```{r}
world_map = read_country_boundaries()
```

Load community data, and create long format version
```{r}
communities = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'communities_for_analysis.csv'))
communities
```

```{r}
community_summary = communities %>% group_by(city_id) %>% summarise(regional_pool_size = n(), urban_pool_size = sum(relative_abundance_proxy > 0))
community_summary
```

Load trait data
```{r}
traits = read_csv(filename(TAXONOMY_OUTPUT_DIR, 'traits_ebird.csv'))
head(traits)
```

Load spatial var
```{r}
spatial_var = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'spatial_var.csv')) %>% filter(city_id %in% community_summary$city_id)
spatial_var
```

# Summary metrics by Realm
```{r}
test_required_values = function(name, df) {
  cat(paste(
    test_value_wilcox(paste(name, 'Std: MNTD'), df$mntd_standard),
    test_value_wilcox(paste(name, 'Std: Beak Width FDiv'), df$beak_width_fdiv_standard),
    test_value_wilcox(paste(name, 'Std: HWI FDiv'), df$hwi_fdiv_standard),
    test_value_wilcox(paste(name, 'Std: Mass FDiv'), df$mass_fdiv_standard),
    
    test_value_wilcox(paste(name, 'Norm: MNTD'), df$mntd_normal, mu = 0.5),
    test_value_wilcox(paste(name, 'Norm: Beak Width FDiv'), df$beak_width_fdiv_normal, mu = 0.5),
    test_value_wilcox(paste(name, 'Norm: HWI FDiv'), df$hwi_fdiv_normal, mu = 0.5),
    test_value_wilcox(paste(name, 'Norm: Mass FDiv'), df$mass_fdiv_normal, mu = 0.5),
    paste('N', nrow(df)),
    sep = "\n"))
}
```

```{r}
test_required_values('Global', community_data_with_realm)
```

```{r}
unique(community_data_with_realm$core_realm)
```

```{r}
test_required_values('Nearctic', community_data_with_realm[community_data_with_realm$core_realm == 'Nearctic',])
```

```{r}
test_required_values('Neotropic', community_data_with_realm[community_data_with_realm$core_realm == 'Neotropic',])
```

```{r}
test_required_values('Palearctic', community_data_with_realm[community_data_with_realm$core_realm == 'Palearctic',])
```

```{r}
test_required_values('Afrotropic', community_data_with_realm[community_data_with_realm$core_realm == 'Afrotropic',])
```

```{r}
test_required_values('Indomalayan', community_data_with_realm[community_data_with_realm$core_realm == 'Indomalayan',])
```

```{r}
test_required_values('Australasia', community_data_with_realm[community_data_with_realm$core_realm == 'Australasia',])
```

## How significant are those differences:
```{r}
print('Standard')
kruskal.test(mntd_standard~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$mntd_standard, community_data_with_realm$core_realm)
print('Normal')
kruskal.test(mntd_normal~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$mntd_normal, community_data_with_realm$core_realm)
```

```{r}
print('Standard')
kruskal.test(beak_width_fdiv_standard~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$beak_width_fdiv_standard, community_data_with_realm$core_realm)
print('Normal')
kruskal.test(beak_width_fdiv_standard~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$beak_width_fdiv_standard, community_data_with_realm$core_realm)
```

```{r}
print('Standard')
kruskal.test(hwi_fdiv_standard~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$hwi_fdiv_standard, community_data_with_realm$core_realm)
print('Normal')
kruskal.test(hwi_fdiv_normal~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$hwi_fdiv_normal, community_data_with_realm$core_realm)
```

```{r}
print('Standard')
kruskal.test(mass_fdiv_standard~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$mass_fdiv_standard, community_data_with_realm$core_realm)
print('Normal')
kruskal.test(mass_fdiv_normal~core_realm, data = community_data_with_realm)
pairwise.wilcox.test(community_data_with_realm$mass_fdiv_normal, community_data_with_realm$core_realm)
```
# What families exist in which realms?
```{r}
communities %>% 
  left_join(city_to_realm) %>% 
  mutate(family = gsub( " .*$", "", ebird_species_name)) %>%
  dplyr::select(family, core_realm) %>%
  distinct() %>%
  arrange(core_realm)
```

## Total urban families
```{r}
communities %>% 
  mutate(family = gsub( " .*$", "", ebird_species_name)) %>%
  dplyr::select(family) %>%
  distinct() %>%
  arrange()
```

of which urban
```{r}
communities %>% 
  filter(relative_abundance_proxy > 0) %>%
  mutate(family = gsub( " .*$", "", ebird_species_name)) %>%
  dplyr::select(family) %>%
  distinct() %>%
  arrange()
```

# Summary metrics by introduced species
```{r}
communities = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'communities_for_analysis.csv'))
city_introduced_species = communities %>% group_by(city_id) %>% summarise(number_of_species = n()) %>% left_join(
  communities %>% group_by(city_id) %>% filter(origin == 'Introduced') %>% summarise(number_of_introduced_species = n())
) %>% replace_na(list(number_of_introduced_species = 0))

community_data_with_introductions = left_join(community_data, city_introduced_species)
community_data_with_introductions$has_introduced_species = community_data_with_introductions$number_of_introduced_species > 0
community_data_with_introductions
```

```{r}
communities %>% 
  filter(origin == 'Introduced') %>%
  dplyr::select(ebird_species_name) %>%
  group_by(ebird_species_name) %>%
  summarise(total_cities = n()) %>%
  arrange(desc(total_cities))
```

```{r}
community_data_with_introductions[,c('mntd_standard', 'has_introduced_species')]
```

```{r}
community_data_with_introductions %>% group_by(has_introduced_species) %>% summarise(
  total_cities = n(), 
  
  mean_mntd_std = mean(mntd_standard, na.rm = T),
  median_mntd_std = median(mntd_standard, na.rm = T),
  sd_mntd_std = sd(mntd_standard, na.rm = T),
  
  mean_mass_fdiv_std = mean(mass_fdiv_standard, na.rm = T),
  median_mass_fdiv_std = median(mass_fdiv_standard, na.rm = T),
  sd_mass_fdiv_std = sd(mass_fdiv_standard, na.rm = T),
  
  mean_gape_width_fdiv_std = mean(beak_width_fdiv_standard, na.rm = T),
  median_gape_width_fdiv_std = median(beak_width_fdiv_standard, na.rm = T),
  sd_gape_width_fdiv_std = sd(beak_width_fdiv_standard, na.rm = T),
  
  mean_handwing_index_fdiv_std = mean(hwi_fdiv_standard, na.rm = T),
  median_handwing_index_fdiv_std = median(hwi_fdiv_standard, na.rm = T),
  sd_handwing_index_fdiv_std = sd(hwi_fdiv_standard, na.rm = T)
)
```

## MNTD
```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = mntd_standard)) + geom_boxplot()
```
```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = mntd_normal)) + geom_boxplot()
```

```{r}
wilcox.test(mntd_standard ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```

There is a significant difference between the response of cities with introduced species (0.53±0.27) and those without (0.47±0.19) (p-value = 0.02).


```{r}
wilcox.test(mntd_normal ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```

## Mass FDiv
```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = mass_fdiv_standard)) + geom_boxplot()
```

```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = mass_fdiv_normal)) + geom_boxplot()
```
```{r}
wilcox.test(mass_fdiv_standard ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```
There is a significant difference between the response of cities with introduced species (0.57±0.27) and those without (0.73±0.24) (p < 0.0001)

```{r}
wilcox.test(mass_fdiv_normal ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```

## Beak Gape FDiv
```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = beak_width_fdiv_standard)) + geom_boxplot()
```

```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = beak_width_fdiv_normal)) + geom_boxplot()
```
```{r}
wilcox.test(beak_width_fdiv_standard ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```
There is NOT a significant difference between the response of cities with introduced species (0.61±0.30) and those without (0.56±0.27)

```{r}
wilcox.test(beak_width_fdiv_normal ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```

## HWI FDiv
```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = hwi_fdiv_standard)) + geom_boxplot()
```

```{r}
ggplot(community_data_with_introductions, aes(x = has_introduced_species, y = hwi_fdiv_normal)) + geom_boxplot()
```

```{r}
wilcox.test(hwi_fdiv_standard ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```
There is a significant difference between the response of cities with introduced species (0.49±0.30) and those without (0.79±0.21) (p < 0.0001)

```{r}
wilcox.test(hwi_fdiv_normal ~ has_introduced_species, community_data_with_introductions, na.action = 'na.omit')
```

## What proportion of cities in each realm have introduced species
```{r}
community_data_with_introductions %>% left_join(city_to_realm) %>%
  group_by(core_realm) %>%
  summarise(
    total_cities = n(), 
    total_cities_with_introduced = sum(has_introduced_species), 
    total_cities_without_introduced = n() - sum(has_introduced_species)) %>%
  arrange(core_realm)
```

## Are any introduced species not also present in a city?
```{r}
communities %>% 
  filter(origin == 'Introduced') %>% 
  filter(relative_abundance_proxy < 0.1)
```

## What's the average relative abundance of introduced species compared to native
```{r}
communities %>% 
  group_by(origin) %>% 
  summarise(average_relative_abundance = mean(relative_abundance_proxy))
```

```{r}
communities %>% 
  group_by(origin) %>% 
  filter(relative_abundance_proxy > 0) %>%
  summarise(average_relative_abundance = mean(relative_abundance_proxy))
```

```{r}
communities %>% 
  group_by(origin) %>% 
  summarise(average_relative_abundance = mean(relative_abundance_proxy))
```

# Create analysis data frame
```{r}
geography = read_csv(filename(CITY_DATA_OUTPUT_DIR, 'geography.csv'))
names(geography)
```

```{r}
analysis_data = community_data_with_realm[,c('city_id', 
       'mntd_standard', 'mass_fdiv_standard', 'beak_width_fdiv_standard', 'hwi_fdiv_standard',
       'mntd_normal', 'mass_fdiv_normal', 'beak_width_fdiv_normal', 'hwi_fdiv_normal',
       'core_realm')] %>% 
  left_join(city_points[,c('city_id', 'latitude', 'longitude')]) %>%
  left_join(community_data_with_introductions[,c('city_id', 'has_introduced_species')]) %>%
  left_join(geography) %>%
  left_join(spatial_var)

analysis_data$abs_latitude = abs(analysis_data$latitude)
analysis_data$core_realm = factor(analysis_data$core_realm, levels = c('Palearctic', 'Nearctic', 'Neotropic', 'Afrotropic', 'Indomalayan', 'Australasia', 'Oceania'))
analysis_data$has_introduced_species = factor(analysis_data$has_introduced_species, level = c('FALSE', 'TRUE'), labels = c('No introduced species', 'Introduced species'))
```

```{r}
model_data = function(df, dependant_var) {
  df[,c(dependant_var, 'core_realm', 'abs_latitude', 'longitude', 'has_introduced_species', 'city_avg_ndvi', 'city_avg_elevation', 'city_avg_temp', 'city_avg_min_monthly_temp', 'city_avg_max_monthly_temp', 'city_avg_monthly_temp', 'city_avg_rainfall', 'city_avg_max_monthly_rainfall', 'city_avg_min_monthly_rainfall', 'city_avg_soil_moisture', 'city_max_elev', 'city_min_elev', 'city_elev_range', 'region_20km_avg_ndvi', 'region_20km_avg_elevation', 'region_20km_avg_soil_moisture', 'region_20km_max_elev', 'region_20km_min_elev', 'region_20km_elev_range', 'region_50km_avg_ndvi', 'region_50km_avg_elevation', 'region_50km_avg_soil_moisture', 'region_50km_max_elev', 'region_50km_min_elev', 'region_50km_elev_range')]
}
model_data(analysis_data, 'mntd_standard')
model_data(analysis_data, 'mntd_normal')
```

```{r}
names(analysis_data)
```

## NMDS Spatial Helpers
```{r}
analysis_data_nmds_coords = analysis_data[,c('NMDS1', 'NMDS2')]
coordinates(analysis_data_nmds_coords)  = ~ NMDS1 + NMDS2

analysis_data_nmds_nearneigh <- knearneigh(analysis_data_nmds_coords)
analysis_data_nmds_neighbours <- knn2nb(analysis_data_nmds_nearneigh)
```

### Polygons around realms in NMDS plot
```{r}
cities_to_realms_nmds = read_csv(filename(CITY_DATA_OUTPUT_DIR, 'realms.csv')) %>% left_join(analysis_data) %>% filter(!is.na(NMDS1))
unique(cities_to_realms_nmds$core_realm)
realm_nmds_neartic_polygon = cities_to_realms_nmds %>% filter(core_realm == 'Nearctic') %>% slice(chull(NMDS1, NMDS2))
realm_nmds_neotropic_polygon = cities_to_realms_nmds %>% filter(core_realm == 'Neotropic') %>% slice(chull(NMDS1, NMDS2))
realm_nmds_palearctic_polygon = cities_to_realms_nmds %>% filter(core_realm == 'Palearctic') %>% slice(chull(NMDS1, NMDS2))
realm_nmds_afrotropic_polygon = cities_to_realms_nmds %>% filter(core_realm == 'Afrotropic') %>% slice(chull(NMDS1, NMDS2))
realm_nmds_indomalayan_polygon = cities_to_realms_nmds %>% filter(core_realm == 'Indomalayan') %>% slice(chull(NMDS1, NMDS2))
realm_nmds_australasia_polygon = cities_to_realms_nmds %>% filter(core_realm == 'Australasia') %>% slice(chull(NMDS1, NMDS2))

polygon_line_type = 'dashed'
polygon_linewidth = 0.4

with_realms_nmds = function(g) {
  g + 
    geom_polygon(data = realm_nmds_neartic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_nmds_neotropic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_nmds_palearctic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_nmds_afrotropic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_nmds_indomalayan_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_nmds_australasia_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0)
}
```

## Lat Long Spatial Helpers
```{r}
analysis_data_latlong_coords = analysis_data[,c('longitude', 'latitude')]
coordinates(analysis_data_latlong_coords)  = ~ longitude + latitude

analysis_data_coords_nearneigh <- knearneigh(analysis_data_latlong_coords, longlat = TRUE)
analysis_data_neighbours <- knn2nb(analysis_data_coords_nearneigh)
```

### Polygons around realms in lat long plot
```{r}
cities_to_realms_latlong = read_csv(filename(CITY_DATA_OUTPUT_DIR, 'realms.csv')) %>% left_join(analysis_data) %>% filter(!is.na(latitude))
unique(cities_to_realms_latlong$core_realm)
realm_latlong_neartic_polygon = cities_to_realms_latlong %>% filter(core_realm == 'Nearctic') %>% slice(chull(latitude, longitude))
realm_latlong_neotropic_polygon = cities_to_realms_latlong %>% filter(core_realm == 'Neotropic') %>% slice(chull(latitude, longitude))
realm_latlong_palearctic_polygon = cities_to_realms_latlong %>% filter(core_realm == 'Palearctic') %>% slice(chull(latitude, longitude))
realm_latlong_afrotropic_polygon = cities_to_realms_latlong %>% filter(core_realm == 'Afrotropic') %>% slice(chull(latitude, longitude))
realm_latlong_indomalayan_polygon = cities_to_realms_latlong %>% filter(core_realm == 'Indomalayan') %>% slice(chull(latitude, longitude))
realm_latlong_australasia_polygon = cities_to_realms_latlong %>% filter(core_realm == 'Australasia') %>% slice(chull(latitude, longitude))

with_realms_latlong = function(g) {
  g + 
    geom_polygon(data = realm_latlong_neartic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_latlong_neotropic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_latlong_palearctic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_latlong_afrotropic_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_latlong_indomalayan_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0) +
    geom_polygon(data = realm_latlong_australasia_polygon, linewidth = polygon_linewidth, linetype = polygon_line_type, alpha = 0)
}
```

# Check for spatial autocorrelation

## MNTD

### Lat/Long
```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = mntd_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$mntd_standard, nb2listw(analysis_data_neighbours))
```
```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = mntd_normal)) + geom_point() + normalised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$mntd_normal, nb2listw(analysis_data_neighbours))
```

### NMDS
```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = mntd_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$mntd_standard, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = mntd_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$mntd_normal, nb2listw(analysis_data_nmds_neighbours))
```

## FDiv Beak Width

### Lat/Long
```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = beak_width_fdiv_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$beak_width_fdiv_standard, nb2listw(analysis_data_neighbours))
```

```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = beak_width_fdiv_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$beak_width_fdiv_normal, nb2listw(analysis_data_neighbours))
```

### NMDS
```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = beak_width_fdiv_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$beak_width_fdiv_standard, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = beak_width_fdiv_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$beak_width_fdiv_normal, nb2listw(analysis_data_nmds_neighbours))
```

## FDiv HWI

### Lat/Long
```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = hwi_fdiv_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$hwi_fdiv_standard, nb2listw(analysis_data_neighbours))
```

```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = hwi_fdiv_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$hwi_fdiv_normal, nb2listw(analysis_data_neighbours))
```

### NMDS
```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = hwi_fdiv_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$hwi_fdiv_standard, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = hwi_fdiv_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$hwi_fdiv_normal, nb2listw(analysis_data_nmds_neighbours))
```

## FDiv Mass

### Lat/Long
```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = mass_fdiv_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$mass_fdiv_standard, nb2listw(analysis_data_neighbours))
```

```{r}
with_realms_latlong(ggplot(analysis_data, aes(x = latitude, y = longitude, colour = mass_fdiv_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$mass_fdiv_normal, nb2listw(analysis_data_neighbours))
```
### NMDS
```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = mass_fdiv_standard)) + geom_point() + standardised_colours_scale + labs(colour = "Standardised response"))
```

```{r}
moran.test(analysis_data$mass_fdiv_standard, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
with_realms_nmds(ggplot(analysis_data, aes(x = NMDS1, y = NMDS2, colour = mass_fdiv_normal)) + geom_point() + standardised_colours_scale + labs(colour = "Normalised response"))
```

```{r}
moran.test(analysis_data$mass_fdiv_normal, nb2listw(analysis_data_nmds_neighbours))
```


# Examine individual metrics
```{r}
all_explanatories = c(
    'city_avg_ndvi', 'city_avg_elevation', 'city_avg_temp',
    'region_50km_avg_soil_moisture',
    'core_realmAfrotropic', 'core_realmAustralasia', 'core_realmIndomalayan', 'core_realmNearctic', 'core_realmNeotropic', 'core_realmPalearctic',
    'has_introduced_speciesNo introduced species', 'has_introduced_speciesIntroduced species'
)

all_explanatory_names = factor(
   c(
    'Avg. NDVI', 'Avg. Elevation', 'Avg. Temp.',
    'Avg. Soil Moisture',
    'Afrotropic', 'Australasia', 'Indomalayan', 'Nearctic', 'Neotropic', 'Palearctic',
    'Introduced Absent', 'Introduced Present'
  ), ordered = T
)

explanatory_dictionary = data.frame(explanatory = all_explanatories, explanatory_name = all_explanatory_names)
  
with_explanatory_type_labels = function(p) {
  p = p[p$explanatory != '(Intercept)',]
  explanatory_levels = all_explanatories[all_explanatories %in% p$explanatory]
  p$explanatory <- factor(p$explanatory, levels = explanatory_levels)
  
  p$type <- 'Realm'
  p$type[p$explanatory %in% c('city_avg_ndvi', 'city_avg_elevation', 'city_avg_temp')] <- 'City geography'
  p$type[p$explanatory %in% c('region_50km_avg_soil_moisture')] <- 'Regional (50 km) geography'
  p$type[p$explanatory %in% c('has_introduced_speciesNo introduced species', 'has_introduced_speciesIntroduced species')] <- 'Introduced species'
  p
}

with_explanatory_names = function(p) {
  p %>% left_join(explanatory_dictionary) %>% arrange(desc(explanatory_name))
}

type_labels = function(p) {
  explanatory_levels = all_explanatories[all_explanatories %in% p$explanatory]
  p$explanatory <- factor(p$explanatory, levels = explanatory_levels)
  
  p$type <- 'Realm'
  p$type[p$explanatory %in% c('city_avg_ndvi', 'city_avg_elevation', 'city_avg_temp', 'city_avg_min_monthly_temp', 'city_avg_max_monthly_temp', 
    'city_avg_monthly_temp', 'city_avg_rainfall', 'city_avg_max_monthly_rainfall', 'city_avg_min_monthly_rainfall', 
    'city_avg_soil_moisture', 'city_max_elev', 'city_min_elev', 'city_elev_range')] <- 'City geography'
  p$type[p$explanatory %in% c('region_50km_avg_ndvi', 'region_50km_avg_elevation', 'region_50km_avg_soil_moisture', 'region_50km_max_elev', 
    'region_50km_min_elev', 'region_50km_elev_range')] <- 'Regional (50 km) geography'
   p$type[p$explanatory %in% c('region_20km_avg_ndvi', 'region_20km_avg_elevation', 'region_20km_avg_soil_moisture', 'region_20km_max_elev', 
    'region_20km_min_elev', 'region_20km_elev_range')] <- 'Regional (20 km) geography'
  p$type[p$explanatory %in% c('has_introduced_speciesNo introduced species', 'has_introduced_speciesIntroduced species')] <- 'Introduced species'
  p
}
```

```{r}
explanatory_labels = c(
  'has_introduced_species'='Introduced species', 
  'has_introduced_speciesNo introduced species'='Introduced absent', 
  'has_introduced_speciesIntroduced species'='Introduced present',
  'city_avg_ndvi'='Average NDVI', 
  'city_avg_elevation'='Average elevation', 
  'city_avg_temp'='Average temperature', 
  'city_avg_min_monthly_temp'='Average minimum monthly temperature', 
  'city_avg_max_monthly_temp'='Average maximum monthly temperature', 
  'city_avg_monthly_temp'='Average monthly temperature', 
  'city_avg_rainfall'='Average rainfall', 
  'city_avg_max_monthly_rainfall'='Average maximum monthly rainfall', 
  'city_avg_min_monthly_rainfall'='Average minimum monthly rainfall', 
  'city_avg_soil_moisture'='Average soil moisture', 
  'city_max_elev'='Maximum elevation', 
  'city_min_elev'='Minimum elevation', 
  'city_elev_range'='Elevation range', 
  'region_20km_avg_ndvi'='Average NDVI', 
  'region_20km_avg_elevation'='Average elevation', 
  'region_20km_avg_soil_moisture'='Average soil moisture', 
  'region_20km_max_elev'='Maximum elevation', 
  'region_20km_min_elev'='Minimum elevation',
  'region_20km_elev_range'='Elevation range',
  'region_50km_avg_ndvi'='Average NDVI',
  'region_50km_avg_elevation'='Average elevation',
  'region_50km_avg_soil_moisture'='Average soil moisture', 
  'region_50km_max_elev'='Maximum elevation',
  'region_50km_min_elev'='Minimum elevation', 
  'region_50km_elev_range'='Elevation range',
  'abs_latitude' = 'Absolute latitude',
  'latitude' = 'Latitude',
  'longitude' = 'Longitude',
  'core_realmAfrotropic' = 'Afrotropical', 
  'core_realmAustralasia' = 'Austaliasian', 
  'core_realmIndomalayan' = 'Indomalayan', 
  'core_realmNearctic' = 'Nearctic', 
  'core_realmNeotropic' = 'Neotropical',
  'core_realmPalearctic' = 'Palearctic',
  'core_realmOceania' = 'Oceanical')
```

```{r}
create_formula = function(response_var) {
  as.formula(paste(response_var, '~ core_realm + city_avg_ndvi + city_avg_elevation + city_avg_temp + region_50km_avg_soil_moisture + has_introduced_species'))
}
```

## Helper plot functions
```{r}
geom_map = function(map_sf, title, scale = standardised_colours_scale, colour_label = 'Standardised\nResponse') {
  norm_mntd_analysis_geo = ggplot() + 
    geom_sf(data = world_map, aes(geometry = geometry)) +
    map_sf +
    scale +
    labs(colour = colour_label) +
    theme_bw() +
    theme(legend.position="bottom")
}

geom_map_std = function(map_sf, title) {
  geom_map(map_sf, title)
}

geom_map_nrm = function(map_sf, title) {
  geom_map(map_sf, title, normalised_colours_scale, 'Normalised\nResponse')
}
```

## Helper Dredge functions
```{r}
# Taken from MuMIN package
# https://rdrr.io/cran/MuMIn/src/R/averaging.R
# https://rdrr.io/cran/MuMIn/src/R/model.avg.R

.coefarr.avg <-
  function(cfarr, weight, revised.var, full, alpha) {	
    weight <- weight / sum(weight)
    nCoef <- dim(cfarr)[3L]
    if(full) {
      nas <- is.na(cfarr[, 1L, ]) & is.na(cfarr[, 2L, ])
      cfarr[, 1L, ][nas] <- cfarr[, 2L, ][nas] <- 0
      #cfarr[, 1L:2L, ][is.na(cfarr[, 1L:2L, ])] <- 0
      if(!all(is.na(cfarr[, 3L, ])))
        cfarr[ ,3L, ][is.na(cfarr[ , 3L, ])] <- Inf
    }
    
    avgcoef <- array(dim = c(nCoef, 5L),
                     dimnames = list(dimnames(cfarr)[[3L]], c("Estimate",
                                                              "Std. Error", "Adjusted SE", "Lower CI", "Upper CI")))
    for(i in seq_len(nCoef))
      avgcoef[i, ] <- par.avg(cfarr[, 1L, i], cfarr[, 2L, i], weight,
                              df = cfarr[, 3L, i], alpha = alpha, revised.var = revised.var)
    
    avgcoef[is.nan(avgcoef)] <- NA
    return(avgcoef)
  }

.makecoefmat <- function(cf) {
  no.ase <- all(is.na(cf[, 3L]))
  z <- abs(cf[, 1L] / cf[, if(no.ase) 2L else 3L])
  pval <- 2 * pnorm(z, lower.tail = FALSE)
  cbind(cf[, if(no.ase) 1L:2L else 1L:3L, drop = FALSE],
        `z value` = z, `Pr(>|z|)` = zapsmall(pval))
}

# Generate model selections using lmer, dredge, and model.avg
# `forumla` : a two-sided linear formula object describing both the fixed-effects and random-effects part of the model
# `data` : the data frame containing the variables from the formula
# `aic_delta` : the AIC delta to use for selecting models in model average
model_average <- function(formula, data, aic_delta = 20) {
  model <- lm(
    formula,
    data=data
  )
  dredge_result <- dredge(model)
  summary(model.avg(dredge_result, subset = delta < aic_delta))
}

# Create a summary data frame containing the selected variables from a model
# `model_sum` : The model summary output from `model_average`
model_summary <- function(model_sum) {
  .column_name <- function(postfix) {
    postfix
  }
  
  # just return the estimate and p value
  weight <- model_sum$msTable[, 5L]
  
  coefmat.full <- as.data.frame(.makecoefmat(.coefarr.avg(model_sum$coefArray, weight,
                                                          attr(model_sum, "revised.var"), TRUE, 0.05)))
  
  coefmat.subset <-
    as.data.frame(.makecoefmat(.coefarr.avg(model_sum$coefArray, weight,
                                            attr(model_sum, "revised.var"), FALSE, 0.05)))
  
  
  coefmat.subset <- coefmat.subset[-c(1), c(1, 2, 5)]
  names(coefmat.subset) <- c(.column_name("estimate"), .column_name("error"), .column_name("p"))
  coefmat.subset <- tibble::rownames_to_column(coefmat.subset, "explanatory")
  coefmat.subset$model = 'subset'
  
  coefmat.full <- coefmat.full[-c(1), c(1, 2, 5)]
  names(coefmat.full) <- c(.column_name("estimate"), .column_name("error"), .column_name("p"))
  coefmat.full <- tibble::rownames_to_column(coefmat.full, "explanatory")
  coefmat.full$model = 'full'
  
  rbind(coefmat.full, coefmat.subset)
}
```

```{r}
plot_dredge_result = function(result_table, mu = 0) {
  p = result_table[result_table$model == 'full',]
  p = type_labels(p)

  ggplot(p, aes(y = explanatory, x = estimate, colour = type)) + 
    geom_line() +
    geom_point() +
    geom_errorbar(aes(xmin=estimate-error, xmax=estimate+error), width=.2,
                   position=position_dodge(0.05)) +
    scale_y_discrete(
      limits = rev(levels(p$explanatory)), 
      labels = explanatory_labels) +
    scale_colour_manual(
      values = c(realm_colour, city_geography_colour, regional_50km_geography_colour, regional_20km_geography_colour, introduced_species_colour), 
      breaks = c('Realm', 'City geography', 'Regional (50 km) geography', 'Regional (20 km) geography', 'Introduced species')) +
    theme_bw() +
    geom_vline(xintercept=mu, linetype="dotted") +
    guides(colour=guide_legend(title="Predictor type")) + xlab('Difference in response from 0\nhabitat filtering (< 0) and competitive interactions (> 0)\n± Standard Error') + ylab('Predictor') +
    theme(legend.justification = "top")
}
```

## GLS Spatial Helpers
```{r}
gls_method = "ML"

spatial_model = function(formula, correlation) {
  gls(
    formula, 
    data = analysis_data, 
    correlation = correlation, 
    method = gls_method
  )
}

plot_spatial_result = function(model_result) {
  model_summary = summary(model_result)
  result_table = as.data.frame(model_summary$tTable)
  result_table$explanatory = rownames(result_table)
  
  result_table = result_table %>% with_explanatory_type_labels() %>% with_explanatory_names()
  
  ggplot2::ggplot(result_table, ggplot2::aes(y=factor(explanatory_name, level = all_explanatory_names, ordered = T), x=Value, colour = type)) + 
    ggplot2::geom_line() +
    ggplot2::geom_point() +
    ggplot2::geom_errorbar(ggplot2::aes(xmin=Value-Std.Error, xmax=Value+Std.Error), width=.2,
                   position=ggplot2::position_dodge(0.05)) +
    ggplot2::theme_bw() +
    ggplot2::geom_vline(xintercept=0, linetype="dotted") +
    ggplot2::theme(legend.justification = "top") +
    ylab('Predictor') +
    guides(colour=guide_legend(title="Predictor type")) + xlab('Difference in response from 0\nhabitat filtering (< 0) and competitive interactions (> 0)\n± Standard Error') +
    scale_colour_manual(
      values = c(realm_colour, city_geography_colour, regional_50km_geography_colour, introduced_species_colour), 
      breaks = c('Realm', 'City geography', 'Regional (50 km) geography', 'Introduced species')) +
    scale_y_discrete(limits = rev(all_explanatory_names[all_explanatory_names %in% result_table$explanatory_name]))
}
```

### Choose best spatial correlation function

#### MNTD
```{r}
AIC(spatial_model(create_formula('mntd_standard'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_standard'), corSpher(form = ~ latitude + longitude)))
```
MNTD: corRatio with NMDS + lat/long

```{r}
AIC(spatial_model(create_formula('mntd_normal'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
#AIC(spatial_model(create_formula('mntd_normal'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mntd_normal'), corSpher(form = ~ latitude + longitude)))
```

#### Beak Width

```{r}
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
#AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_standard'), corSpher(form = ~ latitude + longitude)))
```
Beak width: corExp with NMDS + lat/long

```{r}
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('beak_width_fdiv_normal'), corSpher(form = ~ latitude + longitude)))
```

#### HWI
```{r}
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_standard'), corSpher(form = ~ latitude + longitude)))
```

HWI: corExp with NMDS + lat/long

```{r}
#AIC(spatial_model(create_formula('hwi_fdiv_normal'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
#AIC(spatial_model(create_formula('hwi_fdiv_normal'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('hwi_fdiv_normal'), corSpher(form = ~ latitude + longitude)))
```

#### Mass
```{r}
AIC(spatial_model(create_formula('mass_fdiv_standard'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
#AIC(spatial_model(create_formula('mass_fdiv_standard'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_standard'), corSpher(form = ~ latitude + longitude)))
```

Mass: corExp with NMDS + lat/long

```{r}
#AIC(spatial_model(create_formula('mass_fdiv_normal'), corLin(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
#AIC(spatial_model(create_formula('mass_fdiv_normal'), corLin(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corExp(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corExp(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corGaus(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corGaus(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corRatio(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corRatio(form = ~ latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corSpher(form = ~ NMDS1 + NMDS2 + latitude + longitude)))
AIC(spatial_model(create_formula('mass_fdiv_normal'), corSpher(form = ~ latitude + longitude)))
```

```{r}
correlation_formula = as.formula('~ NMDS1 + NMDS2 + latitude + longitude')

correlation_function_fdiv = function() {
  corExp(form = correlation_formula)
}

correlation_function_mntd = function() {
  corRatio(form = correlation_formula)
}
```

## MNTD

### Standardised
```{r}
std_mntd_analysis_geo_plot = geom_map_std(geom_sf(data = analysis_data, aes(color = mntd_standard, geometry = geometry)), 'MNTD')
std_mntd_analysis_geo_plot
```

```{r}
std_mntd_analysis_data = model_data(analysis_data[!is.na(analysis_data$mntd_standard),], 'mntd_standard')
std_mntd_analysis_formula = create_formula('mntd_standard')
std_mntd_analysis_result = model_average(std_mntd_analysis_formula, std_mntd_analysis_data)
std_mntd_analysis_result_table = model_summary(std_mntd_analysis_result)
std_mntd_analysis_result_table
```

```{r}
std_mntd_analysis_pred_plot = plot_dredge_result(std_mntd_analysis_result_table)
std_mntd_analysis_pred_plot
```

Do the residuals still contain spatial autocorrelation from a fitted lm?
```{r}
std_mntd_lm = lm(std_mntd_analysis_formula, std_mntd_analysis_data)
moran.test(std_mntd_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_mntd_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_mntd_spatial_model = spatial_model(std_mntd_analysis_formula, correlation_function_mntd())
moran.test(std_mntd_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_mntd_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_mntd_analysis_pred_spatial_plot = plot_spatial_result(std_mntd_spatial_model)
std_mntd_analysis_pred_spatial_plot
```

### Normalised
```{r}
nrm_mntd_analysis_geo_plot = geom_map_nrm(geom_sf(data = analysis_data, aes(color = mntd_normal, geometry = geometry)), 'MNTD')
nrm_mntd_analysis_geo_plot
```

```{r}
nrm_mntd_analysis_data = model_data(analysis_data[!is.na(analysis_data$mntd_normal),], 'mntd_normal')
nrm_mntd_analysis_formula = create_formula('mntd_normal')
nrm_mntd_analysis_result = model_average(nrm_mntd_analysis_formula, nrm_mntd_analysis_data)
nrm_mntd_analysis_result_table = model_summary(nrm_mntd_analysis_result)
nrm_mntd_analysis_result_table
```

```{r}
nrm_mntd_analysis_pred_plot = plot_dredge_result(nrm_mntd_analysis_result_table)
nrm_mntd_analysis_pred_plot
```

Do the residuals still contain spatial autocorrelation from a fitted lm?
```{r}
nrm_mntd_lm = lm(nrm_mntd_analysis_formula, nrm_mntd_analysis_data)
moran.test(nrm_mntd_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_mntd_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_mntd_spatial_model = spatial_model(nrm_mntd_analysis_formula, correlation_function_mntd())
moran.test(nrm_mntd_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_mntd_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_mntd_analysis_pred_spatial_plot = plot_spatial_result(nrm_mntd_spatial_model)
nrm_mntd_analysis_pred_spatial_plot
```

## Gape width - FDiv
### Standardised
```{r}
std_gape_fdiv_analysis_geo_plot = geom_map_std(geom_sf(data = analysis_data, aes(color = beak_width_fdiv_standard, geometry = geometry)), 'Beak Width FDiv')
std_gape_fdiv_analysis_geo_plot
```


```{r}
std_gape_fdiv_analysis_data = model_data(analysis_data[!is.na(analysis_data$beak_width_fdiv_standard),], 'beak_width_fdiv_standard')
std_gape_fdiv_analysis_formula = create_formula('beak_width_fdiv_standard')
std_gape_fdiv_analysis_result = model_average(std_gape_fdiv_analysis_formula, std_gape_fdiv_analysis_data)
std_gape_fdiv_analysis_result_table = model_summary(std_gape_fdiv_analysis_result)
std_gape_fdiv_analysis_result_table
```

```{r}
std_gape_fdiv_analysis_pred_plot = plot_dredge_result(std_gape_fdiv_analysis_result_table)
std_gape_fdiv_analysis_pred_plot
```

Do the residuals still contain spatial autocorrelation from a fitted lm?
```{r}
std_gape_fdiv_lm = lm(std_gape_fdiv_analysis_formula, std_gape_fdiv_analysis_data)
moran.test(std_gape_fdiv_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_gape_fdiv_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_gape_fdiv_spatial_model = spatial_model(std_gape_fdiv_analysis_formula, correlation_function_fdiv())
moran.test(std_gape_fdiv_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_gape_fdiv_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_gape_fdiv_analysis_pred_spatial_plot = plot_spatial_result(std_gape_fdiv_spatial_model)
std_gape_fdiv_analysis_pred_spatial_plot
```

### Normalised
```{r}
nrm_gape_fdiv_analysis_geo_plot = geom_map_nrm(geom_sf(data = analysis_data, aes(color = beak_width_fdiv_normal, geometry = geometry)), 'Beak Width FDiv')
nrm_gape_fdiv_analysis_geo_plot
```


```{r}
nrm_gape_fdiv_analysis_data = model_data(analysis_data[!is.na(analysis_data$beak_width_fdiv_normal),], 'beak_width_fdiv_normal')
nrm_gape_fdiv_analysis_formula = create_formula('beak_width_fdiv_normal')
nrm_gape_fdiv_analysis_result = model_average(nrm_gape_fdiv_analysis_formula, nrm_gape_fdiv_analysis_data)
nrm_gape_fdiv_analysis_result_table = model_summary(nrm_gape_fdiv_analysis_result)
nrm_gape_fdiv_analysis_result_table
```

```{r}
nrm_gape_fdiv_analysis_pred_plot = plot_dredge_result(nrm_gape_fdiv_analysis_result_table)
nrm_gape_fdiv_analysis_pred_plot
```

Do the residuals still contain spatial autocorrelation from a fitted lm?
```{r}
nrm_gape_fdiv_lm = lm(nrm_gape_fdiv_analysis_formula, nrm_gape_fdiv_analysis_data)
moran.test(nrm_gape_fdiv_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_gape_fdiv_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_gape_fdiv_spatial_model = spatial_model(nrm_gape_fdiv_analysis_formula, correlation_function_fdiv())
moran.test(nrm_gape_fdiv_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_gape_fdiv_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_gape_fdiv_analysis_pred_spatial_plot = plot_spatial_result(nrm_gape_fdiv_spatial_model)
nrm_gape_fdiv_analysis_pred_spatial_plot
```

## HWI - FDiv
### Standardised
```{r}
std_hwi_fdiv_analysis_geo_plot = geom_map_std(geom_sf(data = analysis_data, aes(color = hwi_fdiv_standard, geometry = geometry)), 'HWI FDiv')
std_hwi_fdiv_analysis_geo_plot
```



```{r}
std_hwi_fdiv_analysis_data = model_data(analysis_data[!is.na(analysis_data$hwi_fdiv_standard),], 'hwi_fdiv_standard')
std_hwi_fdiv_analysis_formula = create_formula('hwi_fdiv_standard')
std_hwi_fdiv_analysis_result = model_average(std_hwi_fdiv_analysis_formula, std_hwi_fdiv_analysis_data)
std_hwi_fdiv_analysis_result_table = model_summary(std_hwi_fdiv_analysis_result)
std_hwi_fdiv_analysis_result_table
```

```{r}
std_hwi_fdiv_analysis_pred_plot = plot_dredge_result(std_hwi_fdiv_analysis_result_table)
std_hwi_fdiv_analysis_pred_plot
```

```{r}
std_hwi_fdiv_lm = lm(std_hwi_fdiv_analysis_formula, std_hwi_fdiv_analysis_data)
moran.test(std_hwi_fdiv_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_hwi_fdiv_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_hwi_fdiv_spatial_model = spatial_model(std_hwi_fdiv_analysis_formula, correlation_function_fdiv())
moran.test(std_hwi_fdiv_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_hwi_fdiv_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_hwi_fdiv_analysis_pred_spatial_plot = plot_spatial_result(std_hwi_fdiv_spatial_model)
std_hwi_fdiv_analysis_pred_spatial_plot
```

### Normalised
```{r}
nrm_hwi_fdiv_analysis_geo_plot = geom_map_nrm(geom_sf(data = analysis_data, aes(color = hwi_fdiv_normal, geometry = geometry)), 'HWI FDiv')
nrm_hwi_fdiv_analysis_geo_plot
```


```{r}
nrm_hwi_fdiv_analysis_data = model_data(analysis_data[!is.na(analysis_data$hwi_fdiv_normal),], 'hwi_fdiv_normal')
nrm_hwi_fdiv_analysis_formula = create_formula('hwi_fdiv_normal')
nrm_hwi_fdiv_analysis_result = model_average(nrm_hwi_fdiv_analysis_formula, nrm_hwi_fdiv_analysis_data)
nrm_hwi_fdiv_analysis_result_table = model_summary(nrm_hwi_fdiv_analysis_result)
nrm_hwi_fdiv_analysis_result_table
```

```{r}
nrm_hwi_fdiv_analysis_pred_plot = plot_dredge_result(nrm_hwi_fdiv_analysis_result_table)
nrm_hwi_fdiv_analysis_pred_plot
```

```{r}
nrm_hwi_fdiv_lm = lm(nrm_hwi_fdiv_analysis_formula, nrm_hwi_fdiv_analysis_data)
moran.test(nrm_hwi_fdiv_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_hwi_fdiv_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_hwi_fdiv_spatial_model = spatial_model(nrm_hwi_fdiv_analysis_formula, correlation_function_fdiv())
moran.test(nrm_hwi_fdiv_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_hwi_fdiv_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_hwi_fdiv_analysis_pred_spatial_plot = plot_spatial_result(nrm_hwi_fdiv_spatial_model)
nrm_hwi_fdiv_analysis_pred_spatial_plot
```

## Mass - FDiv
### Standardised
```{r}
std_mass_fdiv_analysis_geo_plot = geom_map_std(geom_sf(data = analysis_data, aes(color = mass_fdiv_standard, geometry = geometry)), 'Mass FDiv')
std_mass_fdiv_analysis_geo_plot
```


```{r}
std_mass_fdiv_analysis_data = model_data(analysis_data[!is.na(analysis_data$mass_fdiv_standard),], 'mass_fdiv_standard')
std_mass_fdiv_analysis_formula = create_formula('mass_fdiv_standard')
std_mass_fdiv_analysis_result <- model_average(std_mass_fdiv_analysis_formula, std_mass_fdiv_analysis_data)
std_mass_fdiv_analysis_result_table = model_summary(std_mass_fdiv_analysis_result)
std_mass_fdiv_analysis_result_table
```

```{r}
std_mass_fdiv_analysis_pred_plot = plot_dredge_result(std_mass_fdiv_analysis_result_table)
std_mass_fdiv_analysis_pred_plot
```

```{r}
std_mass_fdiv_lm = lm(std_mass_fdiv_analysis_formula, std_mass_fdiv_analysis_data)
moran.test(std_mass_fdiv_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_mass_fdiv_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_mass_fdiv_spatial_model = spatial_model(std_mass_fdiv_analysis_formula, correlation_function_fdiv())
moran.test(std_mass_fdiv_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(std_mass_fdiv_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
std_mass_fdiv_analysis_pred_spatial_plot = plot_spatial_result(std_mass_fdiv_spatial_model)
std_mass_fdiv_analysis_pred_spatial_plot
```


### Normalised
```{r}
nrm_mass_fdiv_analysis_geo_plot = geom_map_nrm(geom_sf(data = analysis_data, aes(color = mass_fdiv_normal, geometry = geometry)), 'Mass FDiv')
nrm_mass_fdiv_analysis_geo_plot
```


```{r}
nrm_mass_fdiv_analysis_data = model_data(analysis_data[!is.na(analysis_data$mass_fdiv_normal),], 'mass_fdiv_normal')
nrm_mass_fdiv_analysis_formula = create_formula('mass_fdiv_normal')
nrm_mass_fdiv_analysis_result = model_average(nrm_mass_fdiv_analysis_formula, nrm_mass_fdiv_analysis_data)
nrm_mass_fdiv_analysis_result_table = model_summary(nrm_mass_fdiv_analysis_result)
nrm_mass_fdiv_analysis_result_table
```

```{r}
nrm_mass_fdiv_analysis_pred_plot = plot_dredge_result(nrm_mass_fdiv_analysis_result_table)
nrm_mass_fdiv_analysis_pred_plot
```

```{r}
nrm_mass_fdiv_lm = lm(nrm_mass_fdiv_analysis_formula, nrm_mass_fdiv_analysis_data)
moran.test(nrm_mass_fdiv_lm$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_mass_fdiv_lm$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_mass_fdiv_spatial_model = spatial_model(nrm_mass_fdiv_analysis_formula, correlation_function_fdiv())
moran.test(nrm_mass_fdiv_spatial_model$residuals, nb2listw(analysis_data_neighbours))
moran.test(nrm_mass_fdiv_spatial_model$residuals, nb2listw(analysis_data_nmds_neighbours))
```

```{r}
nrm_mass_fdiv_analysis_pred_spatial_plot = plot_spatial_result(nrm_mass_fdiv_spatial_model)
nrm_mass_fdiv_analysis_pred_spatial_plot
```

# Create plot of differences in process response
```{r}
pred_legend <- ggpubr::get_legend(
  # create some space to the left of the legend
  std_hwi_fdiv_analysis_pred_plot + theme(legend.box.margin = margin(0, 0, 0, 0)) + guides(colour=guide_legend(ncol=2)) + labs(color = "Predictor type")
)
geo_legend <- ggpubr::get_legend(
  # create some space to the left of the legend
  std_mass_fdiv_analysis_geo_plot + theme(legend.box.margin = margin(-80, 0, 0, 12), legend.title.position = "top", legend.key.width = unit(10, 'mm')) + labs(color = "Standardised response")
)

legend = plot_grid(
  geo_legend,
  pred_legend, 
  nrow = 1
)
legend
```

```{r}
plot_grid(
  plot_grid(
    std_mntd_analysis_geo_plot + theme(legend.position="none"), 
    std_mntd_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrow = 1
  ) + draw_label("MNTD", size = 16, angle = 90, x = 0.01, y = 0.5),
  plot_grid(
    std_gape_fdiv_analysis_geo_plot + theme(legend.position="none"), 
    std_gape_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrow = 1
  ) + draw_label("Beak Width", size = 16, angle = 90, x = 0.01, y = 0.5),
  plot_grid(
    std_hwi_fdiv_analysis_geo_plot + theme(legend.position="none"), 
    std_hwi_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrow = 1
  ) + draw_label("HWI", size = 16, angle = 90, x = 0.01, y = 0.5),
  plot_grid(
    std_mass_fdiv_analysis_geo_plot + theme(legend.position="none"), 
    std_mass_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrow = 1
  ) + draw_label("Mass", size = 16, angle = 90, x = 0.01, y = 0.5), 
  legend,
  nrow = 5
)
ggsave(filename(FIGURES_OUTPUT_DIR, 'process_response.jpg'), width = 3000, height = 3200, units = 'px')
```

```{r}
pred_fig_legend <- ggpubr::get_legend(
  # create some space to the left of the legend
  std_hwi_fdiv_analysis_pred_plot + theme(legend.box.margin = margin(0, 0, 0, -20)) + guides(colour=guide_legend(ncol=2)) + labs(color = "Predictor type")
)
geo_fig_legend <- ggpubr::get_legend(
  # create some space to the left of the legend
  std_mass_fdiv_analysis_geo_plot + theme(legend.box.margin = margin(0, 0, 0, 0), legend.title.position = "top", legend.key.width = unit(10, 'mm')) + labs(color = "Standardised response")
)

remove_x_scale =  scale_x_continuous(name = '', limits = c(-3, 3))
theme_no_legend = theme(legend.position="none", panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))

fig2 = grid.arrange(
  # row 1 - titles
  arrangeGrob(grid::textGrob('A) Standardised response by city', x = 0.1, hjust = 0, gp=gpar(fontface="bold"))),
  arrangeGrob(grid::textGrob('B) Standardised response predictors', x = 0.1, hjust = 0, gp=gpar(fontface="bold"))),
  # row 2
  arrangeGrob(
    std_mntd_analysis_geo_plot + theme_no_legend, 
    left = "MNTD"
  ),
  arrangeGrob(
    std_mntd_analysis_pred_plot + theme_no_legend + remove_x_scale + ylab('')
  ),
  # row 3
  arrangeGrob(std_gape_fdiv_analysis_geo_plot + theme_no_legend, left = "Beak Width"),
  arrangeGrob(
    std_gape_fdiv_analysis_pred_plot + theme_no_legend + remove_x_scale + ylab('')
  ),
  # row 4
  arrangeGrob(std_hwi_fdiv_analysis_geo_plot + theme_no_legend, left = "HWI"),
  arrangeGrob(
    std_hwi_fdiv_analysis_pred_plot + theme_no_legend + remove_x_scale + ylab('')
  ),
  # row 5
  arrangeGrob(std_mass_fdiv_analysis_geo_plot + theme_no_legend, left = "Mass"),
  arrangeGrob(
    std_mass_fdiv_analysis_pred_plot + theme_no_legend + remove_x_scale + ylab('')
  ),
  # row 6 - legends
  arrangeGrob(geo_fig_legend),
  arrangeGrob(pred_fig_legend),
  heights = c(0.5, 2, 2, 2, 2, 1.25),
  nrow = 6
  )
```

```{r}
jpeg(filename(FIGURES_OUTPUT_DIR, 'figure2.jpg'), width = 183, height = 180, units = 'mm', res = 450)
grid.arrange(
  arrangeGrob(fig2),
  ncol = 1
  )
dev.off()
```

```{r}
pdf(filename(FIGURES_OUTPUT_DIR, 'figure2.pdf'), width = 12, height = 12, family = "Helvetica")
grid.arrange(
  arrangeGrob(fig2),
  ncol = 1
  )
dev.off()
```

# Compare to spatial model

```{r}
plot_grid(
  plot_grid(
    ggdraw() + 
    draw_label(
      "Spatial Model (standardised)",
      fontface = 'bold',
      x = 0,
      hjust = 0
    ),
    ggdraw() + 
    draw_label(
      "Spatial Model (normalised)",
      fontface = 'bold',
      x = 0,
      hjust = 0
    ),
    ggdraw() + 
    draw_label(
      "Dredge Result (standardised)",
      fontface = 'bold',
      x = 0,
      hjust = 0
    ),
    ggdraw() + 
    draw_label(
      "Dredge Result (normalised)",
      fontface = 'bold',
      x = 0,
      hjust = 0
    ),
    nrow = 1
  ),
  plot_grid(
    std_mntd_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrm_mntd_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    std_mntd_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrm_mntd_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    nrow = 1
  ) + draw_label("MNTD", size = 16, angle = 90, x = 0.01, y = 0.5),
  plot_grid(
    std_gape_fdiv_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrm_gape_fdiv_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    std_gape_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''),  
    nrm_gape_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    nrow = 1
  ) + draw_label("Beak Width", size = 16, angle = 90, x = 0.01, y = 0.5),
  plot_grid(
    std_hwi_fdiv_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrm_hwi_fdiv_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    std_hwi_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''),  
    nrm_hwi_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    nrow = 1
  ) + draw_label("HWI", size = 16, angle = 90, x = 0.01, y = 0.5),
  plot_grid(
    std_mass_fdiv_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''), 
    nrm_mass_fdiv_analysis_pred_spatial_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    std_mass_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-3, 3)) + ylab(''),  
    nrm_mass_fdiv_analysis_pred_plot + theme(legend.position="none") + scale_x_continuous(name = '', limits = c(-1, 1)) + ylab(''), 
    nrow = 1
  ) + draw_label("Mass", size = 16, angle = 90, x = 0.01, y = 0.5), 
  nrow = 5, rel_heights = c(1, 4, 4, 4, 4)
)
ggsave(filename(FIGURES_OUTPUT_DIR, 'process_response_vs_spatial.jpg'), width = 4000, height = 3200, units = 'px')
```



# Compare metrics against each other
```{r}
ggplot(analysis_data, aes(x = beak_width_fdiv_standard, y = mntd_standard, colour = core_realm)) + 
  geom_point() +
  ylab("MNTD") + 
  xlab("Beak Width FDiv") +
  theme_bw() + labs(color = "Realm")
```

```{r}
ggplot(analysis_data, aes(x = hwi_fdiv_standard, y = mntd_standard, colour = core_realm)) + 
  geom_point() +
  ylab("MNTD") + 
  xlab("HWI FDiv") +
  theme_bw() + labs(color = "Realm")
```

```{r}
ggplot(analysis_data, aes(x = hwi_fdiv_standard, y = beak_width_fdiv_standard, colour = core_realm)) + 
  geom_point() +
  ylab("Beak Width FDiv") + 
  xlab("HWI FDiv") +
  theme_bw() + labs(color = "Realm")
```

```{r}
mntd_fdiv_analysis = analysis_data %>% 
  dplyr::select(city_id,  mntd_standard, hwi_fdiv_standard, beak_width_fdiv_standard, mass_fdiv_standard) %>%
  left_join(community_summary) %>%
  mutate(urban_pool_perc = urban_pool_size * 100 / regional_pool_size)
mntd_fdiv_analysis
```

```{r}
ggpairs(mntd_fdiv_analysis %>% dplyr::select(mntd_standard, hwi_fdiv_standard, beak_width_fdiv_standard, mass_fdiv_standard, regional_pool_size, urban_pool_size, urban_pool_perc), columnLabels = c('MNTD', 'HWI FD', 'Bk FD', 'Mss FD', 'Region Rich.', 'Urban Rich.', '% Urban'))
ggsave(filename(FIGURES_OUTPUT_DIR, 'appendix_standarised_correlation.jpg'))
```



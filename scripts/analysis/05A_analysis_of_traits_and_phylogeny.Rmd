---
title: "Compare urban traits and phylogency"
output: html_notebook
bibliography: ../ref.bib  
---

```{r}
source('../env.R')
```
# Create dataset

Load community data
```{r}
communities = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'communities_for_analysis.csv'))
communities
```
Load trait data
```{r}
traits = read_csv(filename(TAXONOMY_OUTPUT_DIR, 'traits_ebird.csv'))
head(traits)
```

```{r}
species_urban_response = communities %>% group_by(ebird_species_name) %>% summarise(mean_relative_abundance_proxy = mean(relative_abundance_proxy)) %>% left_join(traits)
species_urban_response$is_urban = species_urban_response$mean_relative_abundance_proxy > 0
species_urban_response$ebird_species_name = str_replace(species_urban_response$ebird_species_name,' ', '_')
species_urban_response
```
```{r}
species_urban_response %>% group_by(is_urban) %>% summarise(
  mean_beak_width = mean(beak_width),
  median_beak_width = median(beak_width),
  sd_beak_width = sd(beak_width),
  
  mean_hwi = mean(hwi),
  median_hwi = median(hwi),
  sd_hwi = sd(hwi),
  
  mean_mass = mean(mass),
  median_mass = median(mass),
  sd_mass = sd(mass),
  
  n = n()
)
```

# Compare traits between urban and non-urban species

## Gape Width
```{r}
ggplot(species_urban_response, aes(x = is_urban, y = beak_width)) + geom_boxplot()
```
```{r}
wilcox.test(beak_width ~ is_urban, species_urban_response)
```
There is not a significant response for the gape width between urban species and non urban species.

## HWI
```{r}
ggplot(species_urban_response, aes(x = is_urban, y = hwi)) + geom_boxplot()
```

```{r}
wilcox.test(hwi ~ is_urban, species_urban_response)
```
There is a significant response between urban and non-urban species

## Mass

```{r}
ggplot(species_urban_response, aes(x = is_urban, y = mass)) + geom_boxplot()
```

```{r}
wilcox.test(mass ~ is_urban, species_urban_response)
```

There is not a significant response between species.

# Phylogeny

## Phylogentic response to relative abundance?
```{r}
tree = read.tree(filename(TAXONOMY_OUTPUT_DIR, 'phylogeny.tre'))
tree_pruned = ladderize(drop.tip(tree, setdiff(tree$tip.label, species_urban_response$ebird_species_name)))
ggtree(tree_pruned, layout="fan")
```

```{r}
columbidae_response <- species_urban_response$mean_relative_abundance_proxy
names(columbidae_response) <- species_urban_response$ebird_species_name
```

Is the a phylogenetic signal for our relative abundance proxy
```{r}
col_ut_phylo_signal <- phylosig(tree_pruned, columbidae_response, method="lambda", test=TRUE)
col_ut_phylo_signal
```
## Plot tree
```{r}
abundance_proxy_scale = scale_color_continuous(low='#058f00', high='#3400de')
species_urban_response$ebird_species_name_clean = gsub("_", " ", species_urban_response$ebird_species_name)

g = ggtree(tree_pruned, layout="fan", aes(color = mean_relative_abundance_proxy)) %<+% species_urban_response + abundance_proxy_scale
g + geom_tiplab(size=2, aes(label=ebird_species_name_clean)) +
  labs(color = "Mean relative abundance proxy") + 
  theme(legend.position = "bottom") + ggplot2::xlim(0, 60)

ggsave(filename(FIGURES_OUTPUT_DIR, 'phylogeny.jpg'), width = 2000, height = 2100, units = 'px')
```

## Plot traits against abundance proxy
```{r}
hwi_by_mass = ggplot(species_urban_response, aes(x = hwi, y = mass, colour = mean_relative_abundance_proxy)) + geom_point() + abundance_proxy_scale + theme(legend.position = 'bottom', legend.title.position = 'top', legend.key.width = unit(12, 'mm')) + labs(colour = "Mean relative abundance proxy", y = 'Mass', x = '')
beak_width_by_mass = ggplot(species_urban_response, aes(x = beak_width, y = mass, colour = mean_relative_abundance_proxy)) + geom_point() + abundance_proxy_scale + labs(y = '', x = 'Beak width')
hwi_by_beak_width = ggplot(species_urban_response, aes(x = hwi, y = beak_width, colour = mean_relative_abundance_proxy)) + geom_point() + abundance_proxy_scale + labs(y = 'Beak width', x = 'HWI')

legend <- ggpubr::get_legend(
  # create some space to the left of the legend
  hwi_by_mass
)

plot_grid(
  nrow = 2, ncol = 2,
  hwi_by_mass + theme(legend.position="none"),
  beak_width_by_mass + theme(legend.position="none"),
  hwi_by_beak_width + theme(legend.position="none"),
  legend 
)

ggsave(filename(FIGURES_OUTPUT_DIR, 'traits.jpg'), width = 2000, height = 1800, units = 'px')
```

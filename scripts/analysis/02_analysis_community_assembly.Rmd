---
title: "Metrics for assessing community assembly processes"
output: html_notebook
bibliography: ../ref.bib  
---

```{r}
source('../env.R')
```

```{r}
community_data = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'community_assembly_metrics.csv'))
community_data$is_urban_threshold = factor(community_data$is_urban_threshold, levels = c('low', 'medium', 'high'), labels = c('Low', 'Medium', 'High'))
head(community_data)
colnames(community_data)
```

Join on realms
```{r}
city_to_realm = read_csv(filename(CITY_DATA_OUTPUT_DIR, 'realms.csv'))
community_data_with_realm = left_join(community_data, city_to_realm)
```

Cities as points
```{r}
city_points = st_centroid(read_sf(filename(CITY_DATA_OUTPUT_DIR, 'city_selection.shp')))

city_points_low = city_points %>% left_join(community_data[community_data$is_urban_threshold == 'Low',])
city_points_med = city_points %>% left_join(community_data[community_data$is_urban_threshold == 'Medium',])
city_points_high = city_points %>% left_join(community_data[community_data$is_urban_threshold == 'High',])
```
  
```{r}
world_map = read_country_boundaries()
```
```{r}
normalised_colours_scale = scale_colour_gradient2(
    low = "darkgreen",
    mid = "yellow",
    high = "red",
    midpoint = 0.5,
    space = "Lab",
    na.value = "grey50",
    guide = "colourbar",
    aesthetics = "colour",
  )
```

Load community data, and create long format version
```{r}
communities = read_csv(filename(COMMUNITY_OUTPUT_DIR, 'communities_for_analysis.csv'))

communities_summary = communities %>% group_by(city_id) %>% summarise(
  regional_pool_size = n(), 
  urban_size_high = sum(present_urban_high), 
  urban_size_med = sum(present_urban_med), 
  urban_size_low = sum(present_urban_low)
)

communities_summary_long = bind_rows(
  communities_summary %>% rename(urban_pool_size = 'urban_size_high') %>% dplyr::select(city_id, regional_pool_size, urban_pool_size) %>% mutate(is_urban_threshold = 'High'),
  communities_summary %>% rename(urban_pool_size = 'urban_size_med') %>% dplyr::select(city_id, regional_pool_size, urban_pool_size) %>% mutate(is_urban_threshold = 'Medium'),
  communities_summary %>% rename(urban_pool_size = 'urban_size_low') %>% dplyr::select(city_id, regional_pool_size, urban_pool_size) %>% mutate(is_urban_threshold = 'Low')
)
communities_summary_long
```

Load trait data
```{r}
traits = read_csv(filename(TAXONOMY_OUTPUT_DIR, 'traits_jetz.csv'))
head(traits)
```
Load realm geo
```{r}
resolve = read_resolve()
head(resolve)
```

# Examine individual metrics
```{r}
geom_normalised_histogram = function(name, gg, legend.position = "right") {
  gg + 
    geom_histogram(aes(fill = core_realm), binwidth = 0.1, position = "dodge") +
    geom_vline(aes(xintercept = 0.5), color = "#000000", size = 0.4) +
    geom_vline(aes(xintercept = 0), color = "#000000", size = 0.2, linetype = "dashed") +
    geom_vline(aes(xintercept = 1), color = "#000000", size = 0.2, linetype = "dashed") + 
    ylab("Number of cities") + xlab("Normalised Response") + ylim(c(0, 70)) +
    labs(title = name, fill = 'Realm') +
    facet_wrap(~ is_urban_threshold, ncol=1) + 
    theme_bw() +
    theme(legend.position=legend.position)
}
```

```{r}
geom_map = function(map_sf, title) {
  norm_mntd_analysis_geo = ggplot() + 
    geom_sf(data = world_map, aes(geometry = geometry)) +
    map_sf +
    normalised_colours_scale +
    labs(title = title, colour = 'Normalised\nResponse')
}
```

## MNTD
```{r}
norm_mntd_analysis_plot = geom_normalised_histogram(
  'MNTD', 
  ggplot(community_data_with_realm, aes(mntd_normalised))
)
norm_mntd_analysis_plot
```

```{r}
norm_mntd_analysis_geo = geom_map(geom_sf(data = city_points_low, aes(color = mntd_normalised, geometry = geometry)), 'Low threshold')
norm_mntd_analysis_geo
```

```{r, fig.width = 4, fig.height = 4}
ggarrange(norm_mntd_analysis_plot, 
          ggarrange(
            geom_normalised_histogram('MNTD', ggplot(community_data_with_realm, aes(mntd_normalised)), legend.position = "bottom"), 
            geom_map(geom_sf(data = city_points_med, aes(color = mntd_normalised, geometry = geometry)), 'Medium threshold'),
            geom_map(geom_sf(data = city_points_high, aes(color = mntd_normalised, geometry = geometry)), 'High threshold'),
            ncol=1, common.legend = T),
          ncol = 2)
ggsave(filename(FIGURES_OUTPUT_DIR, 'normalised_mntd.jpg'), width = 2500, height=2500, units = 'px')
```

## FD
```{r}
norm_fd_analysis_plot = geom_normalised_histogram(
  'FD', 
  ggplot(community_data_with_realm, aes(fd_normalised))
)
norm_fd_analysis_plot
```

```{r}
norm_fd_analysis_geo = geom_map(geom_sf(data = city_points_low, aes(color = fd_normalised, geometry = geometry)), 'Low threshold')
norm_fd_analysis_geo
```

```{r, fig.width = 4, fig.height = 4}
ggarrange(geom_normalised_histogram('FD', ggplot(community_data_with_realm, aes(fd_normalised)), legend.position = "bottom"), 
          ggarrange(
            norm_fd_analysis_geo, 
            geom_map(geom_sf(data = city_points_med, aes(color = fd_normalised, geometry = geometry)), 'Medium threshold'),
            geom_map(geom_sf(data = city_points_high, aes(color = fd_normalised, geometry = geometry)), 'High threshold'),
            ncol=1, common.legend = T),
          ncol = 2)
ggsave(filename(FIGURES_OUTPUT_DIR, 'normalised_fd.jpg'), width = 2500, height=2500, units = 'px')
```

## FD - Locomotory
```{r}
norm_fd_loco_analysis_plot = geom_normalised_histogram(
  'FD Locomotory', 
  ggplot(community_data_with_realm, aes(locomotory_trait_fd_normalised))
)
norm_fd_loco_analysis_plot
```

## VAR - Locomotory
```{r}
norm_var_loco_analysis_plot = geom_normalised_histogram(
  'Var Locomotory', 
  ggplot(community_data_with_realm, aes(locomotory_trait_var_normalised))
)
norm_var_loco_analysis_plot
```

## FD - Trophic
```{r}
norm_fd_trophic_analysis_plot = geom_normalised_histogram(
  'FD Trophic', 
  ggplot(community_data_with_realm, aes(trophic_trait_fd_normalised))
)
norm_fd_trophic_analysis_plot
```

## VAR - Trophic
```{r}
norm_var_trophic_analysis_plot = geom_normalised_histogram(
  'Var Trophic', 
  ggplot(community_data_with_realm, aes(trophic_trait_var_normalised))
)
norm_var_trophic_analysis_plot
```

## FD - Gape Width
```{r}
norm_fd_gape_analysis_plot = geom_normalised_histogram(
  'FD Gape Width', 
  ggplot(community_data_with_realm, aes(gape_width_fd_normalised))
)
norm_fd_gape_analysis_plot
```

## VAR - Gape Width
```{r}
norm_var_gape_analysis_plot = geom_normalised_histogram(
  'Var Gape Width', 
  ggplot(community_data_with_realm, aes(gape_width_var_normalised))
)
norm_var_gape_analysis_plot
```

## FD - Mass
```{r}
norm_fd_mass_analysis_plot = geom_normalised_histogram(
  'FD Mass', 
  ggplot(community_data_with_realm, aes(mass_fd_normalised))
)
norm_fd_mass_analysis_plot
```

## VAR - Mass
```{r}
norm_var_mass_analysis_plot = geom_normalised_histogram(
  'Var Mass', 
  ggplot(community_data_with_realm, aes(mass_var_normalised))
)
norm_var_mass_analysis_plot
```

# Compare metrics against each other
```{r}
ggplot(community_data_with_realm, aes(x = fd_normalised, y = mntd_normalised, colour = core_realm)) + 
  geom_point() +
  ylab("MNTD") + 
  xlab("FD") +
  theme_bw() +
  facet_wrap(~ is_urban_threshold, ncol = 2) + labs(color = "Realm")
ggsave(filename(FIGURES_OUTPUT_DIR, 'mntd_by_fd.jpg'))
```

```{r}
mntd_fd_analysis = community_data_with_realm %>% 
  dplyr::select(city_id, is_urban_threshold, mntd_normalised, fd_normalised) %>%
  left_join(communities_summary_long) %>%
  mutate(urban_pool_perc = urban_pool_size * 100 / regional_pool_size)
mntd_fd_analysis
```

```{r}
ggpairs(mntd_fd_analysis %>% dplyr::filter(is_urban_threshold == 'Low') %>% dplyr::select(mntd_normalised, fd_normalised, regional_pool_size, urban_pool_size, urban_pool_perc))
```

```{r}
ggpairs(mntd_fd_analysis %>% dplyr::filter(is_urban_threshold == 'Medium') %>% dplyr::select(mntd_normalised, fd_normalised, regional_pool_size, urban_pool_size, urban_pool_perc))
ggsave(filename(FIGURES_OUTPUT_DIR, 'mntd_by_fd_pairs_medium.jpg'))
```

```{r}
ggpairs(mntd_fd_analysis %>% dplyr::filter(is_urban_threshold == 'High') %>% dplyr::select(mntd_normalised, fd_normalised, regional_pool_size, urban_pool_size, urban_pool_perc))
```


# Plot Urban/Regional Traits

```{r}
communities_with_traits = communities %>% left_join(traits) %>% left_join(city_to_realm) %>% filter(core_realm != 'Oceania')
head(communities_with_traits)
```

```{r}
realms = unique(communities_with_traits$core_realm)
realms
```

```{r}
communities_with_traits_long = bind_rows(
  communities_with_traits %>% dplyr::select(gape_width, trophic_trait, locomotory_trait, mass, core_realm) %>% mutate(record_type = 'Regional'),
  communities_with_traits %>% filter(present_urban_low) %>% dplyr::select(gape_width, trophic_trait, locomotory_trait, mass, core_realm) %>% mutate(record_type = 'Urban Low Threshold'),
  communities_with_traits %>% filter(present_urban_med) %>% dplyr::select(gape_width, trophic_trait, locomotory_trait, mass, core_realm) %>% mutate(record_type = 'Urban Medium Threshold'),
  communities_with_traits %>% filter(present_urban_high) %>% dplyr::select(gape_width, trophic_trait, locomotory_trait, mass, core_realm) %>% mutate(record_type = 'Urban High Threshold')
)
communities_with_traits_long$record_type = factor(communities_with_traits_long$record_type, levels = c('Regional', 'Urban Low Threshold', 'Urban Medium Threshold', 'Urban High Threshold'))

head(communities_with_traits_long)
```

```{r}
convex_hull_loco_trophic_per_realm = function(filtered_df, realms) {
  result = data.frame()
  
  for (realm in realms) {
    result = rbind(result, 
      filtered_df %>% 
        filter(core_realm == realm) %>% 
        slice(chull(trophic_trait, locomotory_trait)) %>% 
        dplyr::select(trophic_trait, locomotory_trait) %>%
        mutate(core_realm = realm)
    )
  }
  
  result
}
```

```{r}
regional_hull = convex_hull_loco_trophic_per_realm(communities_with_traits, realms)
urban_hull_high = convex_hull_loco_trophic_per_realm(communities_with_traits %>% filter(present_urban_high), realms)
urban_hull_med = convex_hull_loco_trophic_per_realm(communities_with_traits %>% filter(present_urban_med), realms)
urban_hull_low = convex_hull_loco_trophic_per_realm(communities_with_traits %>% filter(present_urban_low), realms)

ggplot(data = communities_with_traits_long, aes(x = trophic_trait, y = locomotory_trait)) +
  geom_polygon(data = regional_hull, alpha = 0.1, fill = "green", color="green") +
  geom_polygon(data = urban_hull_low, alpha = 0.15, fill = "yellow", color="yellow") +
  geom_polygon(data = urban_hull_med, alpha = 0.2, fill = "orange", color = "orange") +
  geom_polygon(data = urban_hull_high, alpha = 0.25, fill = "red", color = "red") +
  geom_point(aes(colour = record_type)) +
  theme_bw() + scale_color_manual(values=c("green", "yellow", "orange", "red")) +
  xlab('Trophic Trait') + ylab('Locomotory Trait') + 
  theme(legend.position="bottom") + 
  facet_wrap(~ core_realm)
ggsave(filename(FIGURES_OUTPUT_DIR, 'traits_by_realm_loco_trophic.jpg'))
```
```{r}
convex_hull_gape_mass_per_realm = function(filtered_df, realms) {
  result = data.frame()
  
  for (realm in realms) {
    result = rbind(result, 
      filtered_df %>% 
        filter(core_realm == realm) %>% 
        slice(chull(gape_width, mass)) %>% 
        dplyr::select(gape_width, mass) %>%
        mutate(core_realm = realm)
    )
  }
  
  result
}
```

```{r}
regional_hull_gm = convex_hull_gape_mass_per_realm(communities_with_traits, realms)
urban_hull_high_gm = convex_hull_gape_mass_per_realm(communities_with_traits %>% filter(present_urban_high), realms)
urban_hull_med_gm = convex_hull_gape_mass_per_realm(communities_with_traits %>% filter(present_urban_med), realms)
urban_hull_low_gm = convex_hull_gape_mass_per_realm(communities_with_traits %>% filter(present_urban_low), realms)

ggplot(data = communities_with_traits_long, aes(x = gape_width, y = mass)) +
  geom_polygon(data = regional_hull_gm, alpha = 0.1, fill = "green", color="green") +
  geom_polygon(data = urban_hull_low_gm, alpha = 0.15, fill = "yellow", color="yellow") +
  geom_polygon(data = urban_hull_med_gm, alpha = 0.2, fill = "orange", color = "orange") +
  geom_polygon(data = urban_hull_high_gm, alpha = 0.25, fill = "red", color = "red") +
  geom_point(aes(colour = record_type)) +
  theme_bw() + scale_color_manual(values=c("green", "yellow", "orange", "red")) +
  xlab('Gape Width') + ylab('Mass') + 
  theme(legend.position="bottom") + 
  facet_wrap(~ core_realm)
ggsave(filename(FIGURES_OUTPUT_DIR, 'traits_by_realm_gape_mass.jpg'))
```

# Plot Urban/Regional Phylogeny
```{r}
phylo_tree = read.tree(filename(TAXONOMY_OUTPUT_DIR, 'phylogeny.tre'))
ggtree(phylo_tree, layout='circular')
```

```{r}
plot_phylo = function(realm, community_df = communities_with_traits) {
  species_df = community_df %>% filter(core_realm == realm) %>% group_by(jetz_species_name) %>% summarise(
    regional_pools = n(),
    urban_pools_high = sum(present_urban_high),
    urban_pools_medium = sum(present_urban_med),
    urban_pools_low = sum(present_urban_low)
  ) %>% mutate(
    urban_tolerence_high = urban_pools_high / regional_pools,
    urban_tolerence_med = urban_pools_medium / regional_pools,
    urban_tolerence_low = urban_pools_low / regional_pools
  )
  
  tree_cropped <- ladderize(drop.tip(phylo_tree, setdiff(phylo_tree$tip.label, species_df$jetz_species_name)))
  
  p = ggtree(tree_cropped) + geom_tiplab(align=T) 
  p1 = facet_plot(p, panel='High', data=species_df, geom=geom_segment, aes(x=0, xend=urban_tolerence_high, y=y, yend=y), size=3, color='red') 
  p2 = facet_plot(p1, panel='Medium', data=species_df, geom=geom_segment, aes(x=0, xend=urban_tolerence_med, y=y, yend=y), size=3, color='orange') 
  p3 = facet_plot(p2, panel='Low', data=species_df, geom=geom_segment, aes(x=0, xend=urban_tolerence_low, y=y, yend=y), size=3, color='yellow') 
  
  facet_widths(p3 + xlim_tree(60) + theme_tree2(), c(Tree = 5)) + labs(title = realm, subtitle = 'Urban tolerance')
}
```

```{r}
realms
```

```{r}
plot_phylo('Nearctic')
ggsave(filename(FIGURES_OUTPUT_DIR, 'phylogeny_nearctic.jpg'))
```

```{r, fig.height = 10}
plot_phylo('Neotropic')
ggsave(filename(FIGURES_OUTPUT_DIR, 'phylogeny_neotropic.jpg'), width=2187, units="px")
```

```{r}
plot_phylo('Palearctic')
ggsave(filename(FIGURES_OUTPUT_DIR, 'phylogeny_palearctic.jpg'))
```

```{r}
plot_phylo('Afrotropic')
ggsave(filename(FIGURES_OUTPUT_DIR, 'phylogeny_afrotropic.jpg'))
```

```{r}
plot_phylo('Australasia')
ggsave(filename(FIGURES_OUTPUT_DIR, 'phylogeny_australasia.jpg'))
```

# Species in communities
It seems reasonable to expect that cities with simialr regional pools will have similar species entering the city, and thus a similar response to urbanisation.

```{r}
to_species_matrix = function(filtered_communities) {
  filtered_communities %>% 
    dplyr::select(city_id, jetz_species_name) %>% 
    distinct() %>%
    mutate(present = TRUE) %>% 
    pivot_wider(
      names_from = jetz_species_name, 
      values_from = "present", 
      values_fill = list(present = F)
    ) %>% 
    tibble::column_to_rownames(var='city_id')
}
```

```{r}
community_nmds = function(filtered_communities) {
  species_matrix = to_species_matrix(filtered_communities)
  nmds <- metaMDS(species_matrix, k=2, trymax = 30)
  nmds_result = data.frame(scores(nmds))
  nmds_result$city_id = as.double(rownames(scores(nmds)))
  rownames(nmds_result) = NULL
  
  nmds_result %>%
    left_join(city_points[,c('city_id', 'city_nm')])
}
```

```{r}
plot_nmds = function(plot_data, clusters, realm, plot_is_urban_threshold) {
  pd = plot_data %>%
    left_join(community_data) %>%
    filter(is_urban_threshold == plot_is_urban_threshold)
  
  ggplot(pd, aes(x = NMDS1, y = NMDS2)) + 
    geom_polygon(data = clusters, aes(fill = cluster), alpha = 0.2) +
    geom_jitter(aes(colour = mntd_normalised, size = fd_normalised)) +
    normalised_colours_scale +
    geom_text_repel(aes(label = city_nm), max.overlaps = 25) +
    labs(
      title = realm, 
      subtitle = paste('Regional pool, with urban community values using', plot_is_urban_threshold, 'threshold'), 
      color = 'MNTD Normalised', 
      size = 'FD Normalised')
}
```

https://www.datacamp.com/tutorial/k-means-clustering-r
```{r}
scree_plot = function(community_nmds_data) {
  # Decide how many clusters to look at
  n_clusters <- 10
  
  # Initialize total within sum of squares error: wss
  wss <- numeric(n_clusters)
  
  set.seed(123)
  
  # Look over 1 to n possible clusters
  for (i in 1:n_clusters) {
    # Fit the model: km.out
    km.out <- kmeans(community_nmds_data[,c('NMDS1','NMDS2')], centers = i, nstart = 20)
    # Save the within cluster sum of squares
    wss[i] <- km.out$tot.withinss
  }
  
  # Produce a scree plot
  wss_df <- tibble(clusters = 1:n_clusters, wss = wss)
   
  scree_plot <- ggplot(wss_df, aes(x = clusters, y = wss, group = 1)) +
      geom_point(size = 4)+
      geom_line() +
      scale_x_continuous(breaks = c(2, 4, 6, 8, 10)) +
      xlab('Number of clusters')
  scree_plot
}
```

```{r}
convex_hull_by_cluster = function(community_df) {
  result = data.frame()
  
  clusters = unique(community_df$cluster)
  for (cluster_i in clusters) {
    result = rbind(result, 
      community_df %>% 
        filter(cluster == cluster_i) %>% 
        slice(chull(NMDS1, NMDS2)) %>% 
        dplyr::select(NMDS1, NMDS2, cluster) 
    )
  }
  
  result
}
```


## Nearctic
```{r}
nearctic_communities = community_nmds(communities_with_traits %>% filter(core_realm == 'Nearctic'))    
nearctic_communities
```

```{r}
scree_plot(nearctic_communities)
```

```{r}
nearctic_clusters <- kmeans(nearctic_communities[,c('NMDS1', 'NMDS2')], centers = 3, nstart = 20)
nearctic_communities$cluster = as.factor(nearctic_clusters$cluster)
```

```{r}
ggplot(nearctic_communities, aes(x = NMDS1, y = NMDS2, colour = cluster)) + geom_point()
```


```{r}
nearctic_cluster_hulls = convex_hull_by_cluster(nearctic_communities)
```

```{r}
plot_nmds(nearctic_communities, nearctic_cluster_hulls, 'Nearctic', 'High')
```

```{r}
plot_nmds(nearctic_communities, nearctic_cluster_hulls, 'Nearctic', 'Medium')
```

```{r}
plot_nmds(nearctic_communities, nearctic_cluster_hulls, 'Nearctic', 'Low')
```
```{r}
species_in_neartic = nearctic_communities %>% dplyr::select(city_id, cluster) %>% left_join(communities_with_traits)

plot_phylo('Nearctic', species_in_neartic %>% filter(cluster == 1))
```
```{r}
resolve_nearctic = resolve %>% filter(REALM == 'Nearctic')

ggplot() +
  geom_sf(data = resolve_nearctic, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = nearctic_communities %>% filter(cluster == 1) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Nearctic', species_in_neartic %>% filter(cluster == 2))
```
```{r}
ggplot() +
  geom_sf(data = resolve_nearctic, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = nearctic_communities %>% filter(cluster == 2) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Nearctic', species_in_neartic %>% filter(cluster == 3))
```

```{r}
ggplot() +
  geom_sf(data = resolve_nearctic, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = nearctic_communities %>% filter(cluster == 3) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

## Neotropic
```{r}
neotropic_communities = community_nmds(communities_with_traits %>% filter(core_realm == 'Neotropic'))    
neotropic_communities
```

```{r}
scree_plot(neotropic_communities)
```

```{r}
neotropic_clusters <- kmeans(neotropic_communities[,c('NMDS1', 'NMDS2')], centers = 3, nstart = 20)
neotropic_communities$cluster = as.factor(neotropic_clusters$cluster)
```

```{r}
ggplot(neotropic_communities, aes(x = NMDS1, y = NMDS2, colour = cluster)) + geom_point()
```


```{r}
neotropic_cluster_hulls = convex_hull_by_cluster(neotropic_communities)
```


```{r}
plot_nmds(neotropic_communities, neotropic_cluster_hulls, 'Neotropic', 'High')
```


```{r}
plot_nmds(neotropic_communities, neotropic_cluster_hulls, 'Neotropic', 'Medium')
```

```{r}
plot_nmds(neotropic_communities, neotropic_cluster_hulls, 'Neotropic', 'Low')
```

```{r}
species_in_neotropic = neotropic_communities %>% dplyr::select(city_id, cluster) %>% left_join(communities_with_traits)

plot_phylo('Neotropic', species_in_neotropic %>% filter(cluster == 1))
```

```{r}
resolve_neotropic = resolve %>% filter(REALM == 'Neotropic')

ggplot() +
  geom_sf(data = resolve_neotropic, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = neotropic_communities %>% filter(cluster == 1) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Neotropic', species_in_neotropic %>% filter(cluster == 2))
```

```{r}
ggplot() +
  geom_sf(data = resolve_neotropic, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = neotropic_communities %>% filter(cluster == 2) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Neotropic', species_in_neotropic %>% filter(cluster == 3))
```

```{r}
ggplot() +
  geom_sf(data = resolve_neotropic, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = neotropic_communities %>% filter(cluster == 3) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

## Palearctic

## Afrotropic

## Indomalayan
```{r}
indomalayan_communities = community_nmds(communities_with_traits %>% filter(core_realm == 'Indomalayan'))    
indomalayan_communities
```

```{r}
scree_plot(indomalayan_communities)
```

```{r}
indomalayan_clusters <- kmeans(indomalayan_communities[,c('NMDS1', 'NMDS2')], centers = 4, nstart = 20)
indomalayan_communities$cluster = as.factor(indomalayan_clusters$cluster)
```

```{r}
ggplot(indomalayan_communities, aes(x = NMDS1, y = NMDS2, colour = cluster)) + geom_point()
```

```{r}
indomalayan_cluster_hulls = convex_hull_by_cluster(indomalayan_communities)
```

```{r}
plot_nmds(indomalayan_communities, indomalayan_cluster_hulls, 'Indomalayan', 'High')
```

```{r}
plot_nmds(indomalayan_communities, indomalayan_cluster_hulls, 'Indomalayan', 'Medium')
```

```{r}
plot_nmds(indomalayan_communities, indomalayan_cluster_hulls, 'Indomalayan', 'Low')
```

```{r}
species_in_indomalayan = indomalayan_communities %>% dplyr::select(city_id, cluster) %>% left_join(communities_with_traits)

plot_phylo('Indomalayan', species_in_indomalayan %>% filter(cluster == 1))
```

```{r}
resolve_indomalayan = resolve %>% filter(REALM == 'Indomalayan')

ggplot() +
  geom_sf(data = resolve_indomalayan, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = indomalayan_communities %>% filter(cluster == 1) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Indomalayan', species_in_indomalayan %>% filter(cluster == 2))
```

```{r}
ggplot() +
  geom_sf(data = resolve_indomalayan, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = indomalayan_communities %>% filter(cluster == 2) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Indomalayan', species_in_indomalayan %>% filter(cluster == 3))
```

```{r}
ggplot() +
  geom_sf(data = resolve_indomalayan, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = indomalayan_communities %>% filter(cluster == 3) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

```{r}
plot_phylo('Indomalayan', species_in_indomalayan %>% filter(cluster == 4))
```

```{r}
ggplot() +
  geom_sf(data = resolve_indomalayan, aes(geometry = geometry), alpha = 0.2) +
  geom_sf(data = indomalayan_communities %>% filter(cluster == 4) %>% left_join(city_points_med), aes(color = mntd_normalised, geometry = geometry)) +
  normalised_colours_scale + theme_bw()
```

## Australasia
